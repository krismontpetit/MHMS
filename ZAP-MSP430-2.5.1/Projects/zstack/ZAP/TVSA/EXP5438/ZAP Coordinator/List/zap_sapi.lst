###############################################################################
#                                                                             #
# IAR C/C++ Compiler V5.51.2.50607/W32 for MSP430       04/Apr/2013  15:23:21 #
# Copyright 1996-2012 IAR Systems AB.                                         #
#                                                                             #
#    __rt_version  =  3                                                       #
#    __double_size =  32                                                      #
#    __reg_r4      =  free                                                    #
#    __reg_r5      =  free                                                    #
#    __pic         =  no                                                      #
#    __core        =  430X                                                    #
#    __data_model  =  small                                                   #
#    Source file   =  C:\Users\student\Documents\GitHub\MHMS\ZAP-MSP430-2.5.1 #
#                     \Projects\zstack\ZAP\Source\zap_sapi.c                  #
#    Command line  =  -f C:\Users\student\Documents\GitHub\MHMS\ZAP-MSP430-2. #
#                     5.1\Projects\zstack\ZAP\TVSA\EXP5438\..\..\Source\zap.c #
#                     fg (-DZAP_PHY_SPI=1 -DZAP_PHY_UART=!ZAP_PHY_SPI         #
#                     -DZAP_PHY_RESET_ZNP=TRUE -DZAP_ZNP_MT=FALSE             #
#                     -DZAP_APP_MSG=FALSE -DZAP_SBL_PROXY=FALSE               #
#                     -DZAP_AUTO_CFG=TRUE -DZAP_AUTO_START=TRUE               #
#                     -DZAP_NV_RESTORE=FALSE -DLCD_SUPPORTED                  #
#                     -DZAP_AF_DATA_REQ_FRAG=FALSE                            #
#                     -DZAP_AF_DATA_REQ_AREQ=!ZAP_AF_DATA_REQ_FRAG            #
#                     -DZAP_ZDO_STARTUP_AREQ=TRUE -DZAP_AF_FUNC               #
#                     -DZAP_SAPI_FUNC -DZAP_SYS_FUNC -DZAP_UTIL_FUNC          #
#                     -DZAP_ZDO_FUNC -DSECURE=0 -DZG_SECURE_DYNAMIC=0         #
#                     "-DDEFAULT_CHANLIST=(uint32)0x00000800"                 #
#                     -DZDAPP_CONFIG_PAN_ID=0xFFFF -DPOLL_RATE=1000           #
#                     -DNWK_START_DELAY=100 -DMAX_BINDING_CLUSTER_IDS=4)      #
#                     C:\Users\student\Documents\GitHub\MHMS\ZAP-MSP430-2.5.1 #
#                     \Projects\zstack\ZAP\Source\zap_sapi.c -D               #
#                     ZAP_DEVICETYPE=ZG_DEVICETYPE_COORDINATOR -D             #
#                     TVSA_DEVICE_ID=0x0016 -D TVSA_DONGLE=1 -D HAL_UART=1    #
#                     -lC "C:\Users\student\Documents\GitHub\MHMS\ZAP-MSP430- #
#                     2.5.1\Projects\zstack\ZAP\TVSA\EXP5438\ZAP              #
#                     Coordinator\List\" -lA "C:\Users\student\Documents\GitH #
#                     ub\MHMS\ZAP-MSP430-2.5.1\Projects\zstack\ZAP\TVSA\EXP54 #
#                     38\ZAP Coordinator\List\" --remarks --diag_suppress     #
#                     Pe001,Pe193,Pe236,Pe826 -o                              #
#                     "C:\Users\student\Documents\GitHub\MHMS\ZAP-MSP430-2.5. #
#                     1\Projects\zstack\ZAP\TVSA\EXP5438\ZAP                  #
#                     Coordinator\Obj\" --debug -D__MSP430F5438__ -e          #
#                     --double=32 --clib -I C:\Users\student\Documents\GitHub #
#                     \MHMS\ZAP-MSP430-2.5.1\Projects\zstack\ZAP\TVSA\EXP5438 #
#                     \ -I C:\Users\student\Documents\GitHub\MHMS\ZAP-MSP430- #
#                     2.5.1\Projects\zstack\ZAP\TVSA\EXP5438\..\Source\ -I    #
#                     C:\Users\student\Documents\GitHub\MHMS\ZAP-MSP430-2.5.1 #
#                     \Projects\zstack\ZAP\TVSA\EXP5438\..\..\Source\ -I      #
#                     C:\Users\student\Documents\GitHub\MHMS\ZAP-MSP430-2.5.1 #
#                     \Projects\zstack\ZAP\TVSA\EXP5438\..\..\..\..\..\Compon #
#                     ents\hal\target\MSP5438ZAP\ -I                          #
#                     C:\Users\student\Documents\GitHub\MHMS\ZAP-MSP430-2.5.1 #
#                     \Projects\zstack\ZAP\TVSA\EXP5438\..\..\..\..\..\Compon #
#                     ents\hal\include\ -I C:\Users\student\Documents\GitHub\ #
#                     MHMS\ZAP-MSP430-2.5.1\Projects\zstack\ZAP\TVSA\EXP5438\ #
#                     ..\..\..\..\..\Components\mac\include\ -I               #
#                     C:\Users\student\Documents\GitHub\MHMS\ZAP-MSP430-2.5.1 #
#                     \Projects\zstack\ZAP\TVSA\EXP5438\..\..\..\..\..\Compon #
#                     ents\mt\ -I C:\Users\student\Documents\GitHub\MHMS\ZAP- #
#                     MSP430-2.5.1\Projects\zstack\ZAP\TVSA\EXP5438\..\..\..\ #
#                     ..\..\Components\osal\include\ -I                       #
#                     C:\Users\student\Documents\GitHub\MHMS\ZAP-MSP430-2.5.1 #
#                     \Projects\zstack\ZAP\TVSA\EXP5438\..\..\..\..\..\Compon #
#                     ents\osal\mcu\msp430\ -I C:\Users\student\Documents\Git #
#                     Hub\MHMS\ZAP-MSP430-2.5.1\Projects\zstack\ZAP\TVSA\EXP5 #
#                     438\..\..\..\..\..\Components\services\saddr\ -I        #
#                     C:\Users\student\Documents\GitHub\MHMS\ZAP-MSP430-2.5.1 #
#                     \Projects\zstack\ZAP\TVSA\EXP5438\..\..\..\..\..\Compon #
#                     ents\services\sdata\ -I C:\Users\student\Documents\GitH #
#                     ub\MHMS\ZAP-MSP430-2.5.1\Projects\zstack\ZAP\TVSA\EXP54 #
#                     38\..\..\..\..\..\Components\stack\af\ -I               #
#                     C:\Users\student\Documents\GitHub\MHMS\ZAP-MSP430-2.5.1 #
#                     \Projects\zstack\ZAP\TVSA\EXP5438\..\..\..\..\..\Compon #
#                     ents\stack\nwk\ -I C:\Users\student\Documents\GitHub\MH #
#                     MS\ZAP-MSP430-2.5.1\Projects\zstack\ZAP\TVSA\EXP5438\.. #
#                     \..\..\..\..\Components\stack\sapi\ -I                  #
#                     C:\Users\student\Documents\GitHub\MHMS\ZAP-MSP430-2.5.1 #
#                     \Projects\zstack\ZAP\TVSA\EXP5438\..\..\..\..\..\Compon #
#                     ents\stack\sec\ -I C:\Users\student\Documents\GitHub\MH #
#                     MS\ZAP-MSP430-2.5.1\Projects\zstack\ZAP\TVSA\EXP5438\.. #
#                     \..\..\..\..\Components\stack\sys\ -I                   #
#                     C:\Users\student\Documents\GitHub\MHMS\ZAP-MSP430-2.5.1 #
#                     \Projects\zstack\ZAP\TVSA\EXP5438\..\..\..\..\..\Compon #
#                     ents\stack\zdo\ -I C:\Users\student\Documents\GitHub\MH #
#                     MS\ZAP-MSP430-2.5.1\Projects\zstack\ZAP\TVSA\EXP5438\.. #
#                     \..\..\..\..\Components\zmac\ -I                        #
#                     C:\Users\student\Documents\GitHub\MHMS\ZAP-MSP430-2.5.1 #
#                     \Projects\zstack\ZAP\TVSA\EXP5438\..\..\..\..\..\Compon #
#                     ents\zmac\f8w\ --core=430X --data_model=small -Ohz      #
#                     --multiplier=32 --multiplier_location=4C0               #
#                     --require_prototypes --hw_workaround=CPU40              #
#                     --hw_workaround=CPU42                                   #
#    List file     =  C:\Users\student\Documents\GitHub\MHMS\ZAP-MSP430-2.5.1 #
#                     \Projects\zstack\ZAP\TVSA\EXP5438\ZAP                   #
#                     Coordinator\List\zap_sapi.lst                           #
#    Object file   =  C:\Users\student\Documents\GitHub\MHMS\ZAP-MSP430-2.5.1 #
#                     \Projects\zstack\ZAP\TVSA\EXP5438\ZAP                   #
#                     Coordinator\Obj\zap_sapi.r43                            #
#                                                                             #
#                                                                             #
###############################################################################

C:\Users\student\Documents\GitHub\MHMS\ZAP-MSP430-2.5.1\Projects\zstack\ZAP\Source\zap_sapi.c
      1          /**************************************************************************************************
      2              Filename:       zap_sapi.c
      3              Revised:        $Date: 2011-05-20 18:49:45 -0700 (Fri, 20 May 2011) $
      4              Revision:       $Revision: 26058 $
      5          
      6              Description:
      7          
      8              This file declares the ZNP Application Processor SAPI API functions.
      9          
     10          
     11              Copyright 2009-2011 Texas Instruments Incorporated. All rights reserved.
     12          
     13              IMPORTANT: Your use of this Software is limited to those specific rights
     14              granted under the terms of a software license agreement between the user
     15              who downloaded the software, his/her employer (which must be your employer)
     16              and Texas Instruments Incorporated (the "License").  You may not use this
     17              Software unless you agree to abide by the terms of the License. The License
     18              limits your use, and you acknowledge, that the Software may not be modified,
     19              copied or distributed unless embedded on a Texas Instruments microcontroller
     20              or used solely and exclusively in conjunction with a Texas Instruments radio
     21              frequency transceiver, which is integrated into your product.  Other than for
     22              the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     23              works of, modify, distribute, perform, display or sell this Software and/or
     24              its documentation for any purpose.
     25          
     26              YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     27              PROVIDED “AS IS” WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,
     28              INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE,
     29              NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     30              TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     31              NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     32              LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     33              INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     34              OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     35              OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     36              (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     37          
     38              Should you have any questions regarding your right to use this Software,
     39              contact Texas Instruments Incorporated at www.TI.com.
     40          **************************************************************************************************/
     41          
     42          /* ------------------------------------------------------------------------------------------------
     43           *                                          Includes
     44           * ------------------------------------------------------------------------------------------------
     45           */
     46          
     47          #include "mt.h"
     48          #include "mt_rpc.h"
     49          #include "sapi.h"
     50          #include "zap_app.h"
     51          #include "zap_phy.h"
     52          #include "ZComDef.h"
     53          
     54          #if defined (ZAP_SAPI_FUNC)
     55          /* ------------------------------------------------------------------------------------------------
     56           *                                           Constants
     57           * ------------------------------------------------------------------------------------------------
     58           */
     59          
     60          /* ------------------------------------------------------------------------------------------------
     61           *                                           Typedefs
     62           * ------------------------------------------------------------------------------------------------
     63           */
     64          
     65          /* ------------------------------------------------------------------------------------------------
     66           *                                           Macros
     67           * ------------------------------------------------------------------------------------------------
     68           */
     69          
     70          /* ------------------------------------------------------------------------------------------------
     71           *                                           Global Variables
     72           * ------------------------------------------------------------------------------------------------
     73           */
     74          
     75          /* ------------------------------------------------------------------------------------------------
     76           *                                           Local Variables
     77           * ------------------------------------------------------------------------------------------------
     78           */
     79          
     80          /* ------------------------------------------------------------------------------------------------
     81           *                                           Local Functions
     82           * ------------------------------------------------------------------------------------------------
     83           */
     84          
     85          static uint8 sapiReq(uint8 cmd, uint8 arg, uint8 *req, uint8 len);
     86          
     87          /**************************************************************************************************
     88           * @fn          zapSapiProcessIncoming
     89           *
     90           * @brief       This function processes the SAPI sub-system response from the ZNP.
     91           *
     92           * input parameters
     93           *
     94           * @param       port - Port Id corresponding to the ZNP that sent the message.
     95           * @param       pBuf - A pointer to the RPC response.
     96           *
     97           * output parameters
     98           *
     99           * None.
    100           *
    101           * @return      None.
    102           **************************************************************************************************
    103           */

   \                                 In  segment CODE, align 2
    104          void zapSapiProcessIncoming(uint8 port, uint8 *pBuf)
   \                     zapSapiProcessIncoming:
    105          {
    106            uint8 cmd1 = pBuf[MT_RPC_POS_CMD1];
    107            pBuf += MT_RPC_FRAME_HDR_SZ;
    108          
    109            switch (cmd1)
    110            {
    111            case MT_SAPI_START_CNF:
    112              break;
    113          
    114            case MT_SAPI_BIND_CNF:
    115              break;
    116          
    117            case MT_SAPI_ALLOW_BIND_CNF:
    118              break;
    119          
    120            case MT_SAPI_SEND_DATA_CNF:
    121              break;
    122          
    123            case MT_SAPI_READ_CFG_RSP:
    124              break;
    125          
    126            case MT_SAPI_FIND_DEV_CNF:
    127              break;
    128          
    129            case MT_SAPI_DEV_INFO_RSP:
    130              break;
    131          
    132            case MT_SAPI_RCV_DATA_IND:
    133              break;
    134          
    135            default:
    136              break;
    137            }
    138          }
   \   000000   1001         RETA
    139          
    140          /******************************************************************************
    141           * @fn          zb_PermitJoiningRequest
    142           *
    143           * @brief       The zb_PermitJoiningRequest function is used to control the
    144           *              joining permissions and thus allow or disallow new devices from
    145           *              joining the network.
    146           *
    147           * @param       destination - The destination parameter indicates the address
    148           *                            of the device for which the joining permissions
    149           *                            should be set. This is usually the local device
    150           *                            address or the special broadcast address that denotes
    151           *                            all routers and coordinator ( 0xFFFC ). This way
    152           *                            the joining permissions of a single device or the
    153           *                            whole network can be controlled.
    154           *              timeout -  Indicates the amount of time in seconds for which
    155           *                         the joining permissions should be turned on.
    156           *                         If timeout is set to 0x00, the device will turn off the
    157           *                         joining permissions indefinitely. If it is set to 0xFF,
    158           *                         the joining permissions will be turned on indefinitely.
    159           *
    160           *
    161           * @return      ZB_SUCCESS or a failure code
    162           *
    163           */

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine0:
   \   000000   2153         ADD.W   #0x2, SP
   \   000002   3817         POPM.W  #0x4, R11
   \   000004   1001         RETA

   \                                 In  segment CODE, align 2
    164          uint8 zb_PermitJoiningRequest(uint16 destination, uint8 timeout)
   \                     zb_PermitJoiningRequest:
    165          {
   \   000000   3B15         PUSHM.W #0x4, R11
   \   000002   2183         SUB.W   #0x2, SP
   \   000004   0A4C         MOV.W   R12, R10
   \   000006   4B4D         MOV.B   R13, R11
    166            uint8 rtrn = ZB_FAILURE;
   \   000008   5843         MOV.B   #0x1, R8
    167            uint8 *pBuf = zap_msg_allocate(3, ((uint8)MT_RPC_SYS_SAPI | (uint8)MT_RPC_CMD_SREQ),
    168                                                                               MT_SAPI_PMT_JOIN_REQ);
   \   00000A   7E42         MOV.B   #0x8, R14
   \   00000C   7D402600     MOV.B   #0x26, R13
   \   000010   7C400300     MOV.B   #0x3, R12
   \   000014   ........     CALLA   #zap_msg_allocate
   \   000018   814C0000     MOV.W   R12, 0(SP)
    169            if (pBuf != NULL)
   \   00001C   0C93         CMP.W   #0x0, R12
   \   00001E   1424         JEQ     ??zb_PermitJoiningRequest_0
    170            {
    171              pBuf[0] = LO_UINT16(destination);
   \   000020   CC4A0000     MOV.B   R10, 0(R12)
    172              pBuf[1] = HI_UINT16(destination);
   \   000024                RPT     #0x8
   \   000024   47190A10     RRUX.W  R10
   \   000028   2F41         MOV.W   @SP, R15
   \   00002A   CF4A0100     MOV.B   R10, 0x1(R15)
    173              pBuf[2] = timeout;
   \   00002E   2F41         MOV.W   @SP, R15
   \   000030   CF4B0200     MOV.B   R11, 0x2(R15)
    174          
    175              if (zapPhySend(zapAppPort, pBuf) == SUCCESS)
   \   000034   ........     CALLA   #?Subroutine1
   \                     ??CrossCallReturnLabel_0:
   \   000038   4C93         CMP.B   #0x0, R12
   \   00003A   0220         JNE     ??zb_PermitJoiningRequest_1
    176              {
    177                rtrn = pBuf[0];
   \   00003C   2F41         MOV.W   @SP, R15
   \   00003E   684F         MOV.B   @R15, R8
    178              }
    179          
    180              zap_msg_deallocate(&pBuf);
   \                     ??zb_PermitJoiningRequest_1:
   \   000040   0C41         MOV.W   SP, R12
   \   000042   0C53         ADD.W   #0x0, R12
   \   000044   ........     CALLA   #zap_msg_deallocate
    181            }
    182          
    183            return rtrn;
   \                     ??zb_PermitJoiningRequest_0:
   \   000048   4C48         MOV.B   R8, R12
   \   00004A   ....         JMP     ?Subroutine0
   \   00004C   0343         NOP
    184          }

   \                                 In  segment CODE, align 2
   \                     ?Subroutine1:
   \   000000   1D410400     MOV.W   0x4(SP), R13
   \   000004   5C42....     MOV.B   &zapAppPort, R12
   \   000008   ........     BRA     #zapPhySend
    185          
    186          /**************************************************************************************************
    187           * @fn          zb_GetDeviceInfo
    188           *
    189           * @brief       The zb_GetDeviceInfo function retrieves a Device Information Property.
    190           *
    191           * input parameters
    192           *
    193           * @param       param - The identifier for the device information.
    194           *              pValue - A buffer to hold the device information.
    195           *
    196           * output parameters
    197           *
    198           * None.
    199           *
    200           * @return      None.
    201           **************************************************************************************************
    202           */

   \                                 In  segment CODE, align 2, keep-with-next
    203          void zb_GetDeviceInfo(uint8 param, void *pValue)
   \                     zb_GetDeviceInfo:
    204          {
   \   000000   3B15         PUSHM.W #0x4, R11
   \   000002   31800A00     SUB.W   #0xa, SP
   \   000006   4A4C         MOV.B   R12, R10
   \   000008   0B4D         MOV.W   R13, R11
    205            uint8 pBuf[Z_EXTADDR_LEN+1];
    206            osal_memset(pBuf, 0xFF, 9);
   \   00000A   0841         MOV.W   SP, R8
   \   00000C   0853         ADD.W   #0x0, R8
   \   00000E   3E400900     MOV.W   #0x9, R14
   \   000012   7D43         MOV.B   #0xff, R13
   \   000014   0C48         MOV.W   R8, R12
   \   000016   ........     CALLA   #osal_memset
    207          
    208            if (sapiReq(MT_SAPI_GET_DEV_INFO_REQ, param, pBuf, (Z_EXTADDR_LEN+1)) == FAILURE)
   \   00001A   7F400900     MOV.B   #0x9, R15
   \   00001E   0E48         MOV.W   R8, R14
   \   000020   4D4A         MOV.B   R10, R13
   \   000022   7C400600     MOV.B   #0x6, R12
   \   000026   ........     CALLA   #sapiReq
   \   00002A   5C93         CMP.B   #0x1, R12
   \   00002C   1F24         JEQ     ??zb_GetDeviceInfo_0
    209            {
    210              return;
    211            }
    212          
    213            if (NULL != pValue)
   \   00002E   0B93         CMP.W   #0x0, R11
   \   000030   1D24         JEQ     ??zb_GetDeviceInfo_0
    214            {
    215              uint8 len;
    216          
    217              switch (param)
   \   000032   4A83         SUB.B   #0x0, R10
   \   000034   0F24         JEQ     ??zb_GetDeviceInfo_1
   \   000036   5A83         SUB.B   #0x1, R10
   \   000038   0F24         JEQ     ??zb_GetDeviceInfo_2
   \   00003A   5A83         SUB.B   #0x1, R10
   \   00003C   0F24         JEQ     ??zb_GetDeviceInfo_3
   \   00003E   5A83         SUB.B   #0x1, R10
   \   000040   0D24         JEQ     ??zb_GetDeviceInfo_3
   \   000042   5A83         SUB.B   #0x1, R10
   \   000044   0924         JEQ     ??zb_GetDeviceInfo_2
   \   000046   5A83         SUB.B   #0x1, R10
   \   000048   0524         JEQ     ??zb_GetDeviceInfo_1
   \   00004A   5A83         SUB.B   #0x1, R10
   \   00004C   0724         JEQ     ??zb_GetDeviceInfo_3
   \   00004E   5A83         SUB.B   #0x1, R10
   \   000050   0324         JEQ     ??zb_GetDeviceInfo_2
   \   000052   063C         JMP     ??zb_GetDeviceInfo_4
    218              {
    219              case ZB_INFO_DEV_STATE:
    220              case ZB_INFO_CHANNEL:
    221                len = sizeof(uint8);
   \                     ??zb_GetDeviceInfo_1:
   \   000054   5E43         MOV.B   #0x1, R14
    222                break;
   \   000056   053C         JMP     ??zb_GetDeviceInfo_5
    223          
    224              case ZB_INFO_IEEE_ADDR:
    225              case ZB_INFO_PARENT_IEEE_ADDR:
    226              case ZB_INFO_EXT_PAN_ID:
    227                len = Z_EXTADDR_LEN;
   \                     ??zb_GetDeviceInfo_2:
   \   000058   7E42         MOV.B   #0x8, R14
    228                break;
   \   00005A   033C         JMP     ??zb_GetDeviceInfo_5
    229          
    230              case ZB_INFO_SHORT_ADDR:
    231              case ZB_INFO_PARENT_SHORT_ADDR:
    232              case ZB_INFO_PAN_ID:
    233                len = sizeof(uint16);
   \                     ??zb_GetDeviceInfo_3:
   \   00005C   6E43         MOV.B   #0x2, R14
    234                break;
   \   00005E   013C         JMP     ??zb_GetDeviceInfo_5
    235          
    236              default:
    237                len = 0;
   \                     ??zb_GetDeviceInfo_4:
   \   000060   4E43         MOV.B   #0x0, R14
    238                break;
    239              }
    240          
    241              // The first data byte is just the 'param' echo.
    242              (void)osal_memcpy((uint8 *)pValue, pBuf+1, len);
   \                     ??zb_GetDeviceInfo_5:
   \   000062   1853         ADD.W   #0x1, R8
   \   000064   0D48         MOV.W   R8, R13
   \   000066   0C4B         MOV.W   R11, R12
   \   000068   ........     CALLA   #osal_memcpy
   \                     ??zb_GetDeviceInfo_0:
   \   00006C   31500A00     ADD.W   #0xa, SP
   \   000070   3817         POPM.W  #0x4, R11
   \   000072   1001         RETA
    243            }
    244          }
    245          
    246          /**************************************************************************************************
    247           * @fn          sapiReq
    248           *
    249           * @brief       This function packs and sends an RPC SAPI request.
    250           *
    251           * input parameters
    252           *
    253           * @param       cmd - A valid SAPI command.
    254           * @param       arg - A valid argument corresponding to the SAPI command.
    255           * @param       req - A buffer containing the contents of the request, or NULL.
    256           * @param       len - The non-zero length of a non-NULL req buffer, or NULL.
    257           *
    258           * output parameters
    259           *
    260           * None.
    261           *
    262           * @return      SUCCESS or FAILURE.
    263           **************************************************************************************************
    264           */

   \                                 In  segment CODE, align 2, keep-with-next
    265          static uint8 sapiReq(uint8 cmd, uint8 arg, uint8 *req, uint8 len)
   \                     sapiReq:
    266          {
   \   000000   3B15         PUSHM.W #0x4, R11
   \   000002   2183         SUB.W   #0x2, SP
   \   000004   494D         MOV.B   R13, R9
   \   000006   084E         MOV.W   R14, R8
   \   000008   4B4F         MOV.B   R15, R11
    267            uint8 cmd0 = (MT_SAPI_SYS_RESET == cmd) ? ((uint8)MT_RPC_SYS_SAPI | (uint8)MT_RPC_CMD_AREQ):
    268                                                      ((uint8)MT_RPC_SYS_SAPI | (uint8)MT_RPC_CMD_SREQ);
   \   00000A   7C900900     CMP.B   #0x9, R12
   \   00000E   0324         JEQ     ??sapiReq_0
   \   000010   7D402600     MOV.B   #0x26, R13
   \   000014   023C         JMP     ??sapiReq_1
   \                     ??sapiReq_0:
   \   000016   7D404600     MOV.B   #0x46, R13
    269            uint8 *pBuf = zap_msg_allocate((uint8)(len + 2), cmd0, cmd);
   \                     ??sapiReq_1:
   \   00001A   4E4C         MOV.B   R12, R14
   \   00001C   4C4F         MOV.B   R15, R12
   \   00001E   6C53         ADD.B   #0x2, R12
   \   000020   ........     CALLA   #zap_msg_allocate
   \   000024   814C0000     MOV.W   R12, 0(SP)
    270            uint8 rtrn = FAILURE;
   \   000028   5A43         MOV.B   #0x1, R10
    271          
    272            if (NULL != pBuf)
   \   00002A   0C93         CMP.W   #0x0, R12
   \   00002C   1E24         JEQ     ??sapiReq_2
    273            {
    274              pBuf[0] = arg;
   \   00002E   CC490000     MOV.B   R9, 0(R12)
    275              pBuf[1] = len;
   \   000032   2F41         MOV.W   @SP, R15
   \   000034   CF4B0100     MOV.B   R11, 0x1(R15)
    276              if (NULL != req)
   \   000038   0893         CMP.W   #0x0, R8
   \   00003A   0624         JEQ     ??sapiReq_3
    277              {
    278                (void)osal_memcpy(pBuf+2, req, len);
   \   00003C   4E4B         MOV.B   R11, R14
   \   00003E   0D48         MOV.W   R8, R13
   \   000040   2C41         MOV.W   @SP, R12
   \   000042   2C53         ADD.W   #0x2, R12
   \   000044   ........     CALLA   #osal_memcpy
    279              }
    280          
    281              if (((rtrn = zapPhySend(zapAppPort, pBuf)) == SUCCESS) && (NULL != req))
   \                     ??sapiReq_3:
   \   000048   ........     CALLA   #?Subroutine1
   \                     ??CrossCallReturnLabel_1:
   \   00004C   4A4C         MOV.B   R12, R10
   \   00004E   4C93         CMP.B   #0x0, R12
   \   000050   0820         JNE     ??sapiReq_4
   \   000052   0893         CMP.W   #0x0, R8
   \   000054   0624         JEQ     ??sapiReq_4
    282              {
    283                (void)osal_memcpy(req, pBuf, ZAP_MSG_LEN(pBuf));
   \   000056   2D41         MOV.W   @SP, R13
   \   000058   5E4DFDFF     MOV.B   0xfffd(R13), R14
   \   00005C   0C48         MOV.W   R8, R12
   \   00005E   ........     CALLA   #osal_memcpy
    284              }
    285          
    286              zap_msg_deallocate(&pBuf);
   \                     ??sapiReq_4:
   \   000062   0C41         MOV.W   SP, R12
   \   000064   0C53         ADD.W   #0x0, R12
   \   000066   ........     CALLA   #zap_msg_deallocate
    287            }
    288          
    289            return rtrn;
   \                     ??sapiReq_2:
   \   00006A   4C4A         MOV.B   R10, R12
   \   00006C                REQUIRE ?Subroutine0
   \   00006C                // Fall through to label ?Subroutine0
    290          }
    291          
    292          #endif
    293          /**************************************************************************************************
    294          */

   Maximum stack usage in bytes:

   CSTACK Function
   ------ --------
      14  sapiReq
            14 -> osal_memcpy
            14 -> zapPhySend
            14 -> zap_msg_allocate
            14 -> zap_msg_deallocate
       4  zapSapiProcessIncoming
      22  zb_GetDeviceInfo
            22 -> osal_memcpy
            22 -> osal_memset
            22 -> sapiReq
      14  zb_PermitJoiningRequest
            14 -> zapPhySend
            14 -> zap_msg_allocate
            14 -> zap_msg_deallocate


   Segment part sizes:

   Bytes  Function/Label
   -----  --------------
       6  ?Subroutine0
      12  ?Subroutine1
     108  sapiReq
       2  zapSapiProcessIncoming
     116  zb_GetDeviceInfo
      78  zb_PermitJoiningRequest

 
 322 bytes in segment CODE
 
 322 bytes of CODE memory

Errors: none
Warnings: none
