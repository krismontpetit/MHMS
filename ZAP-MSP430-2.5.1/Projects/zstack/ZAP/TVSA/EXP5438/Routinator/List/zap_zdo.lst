###############################################################################
#                                                                             #
# IAR C/C++ Compiler V5.51.2.50607/W32 for MSP430       19/Apr/2013  11:30:24 #
# Copyright 1996-2012 IAR Systems AB.                                         #
#                                                                             #
#    __rt_version  =  3                                                       #
#    __double_size =  32                                                      #
#    __reg_r4      =  free                                                    #
#    __reg_r5      =  free                                                    #
#    __pic         =  no                                                      #
#    __core        =  430X                                                    #
#    __data_model  =  small                                                   #
#    Source file   =  C:\Users\student\Documents\GitHub\MHMS\MHMS\ZAP-MSP430- #
#                     2.5.1\Projects\zstack\ZAP\Source\zap_zdo.c              #
#    Command line  =  -f C:\Users\student\Documents\GitHub\MHMS\MHMS\ZAP-MSP4 #
#                     30-2.5.1\Projects\zstack\ZAP\TVSA\EXP5438\..\..\Source\ #
#                     zap.cfg (-DTVSA_DEVICE_ID=0x0016 -DZAP_PHY_SPI=1        #
#                     -DZAP_PHY_UART=!ZAP_PHY_SPI -DZAP_PHY_RESET_ZNP=TRUE    #
#                     -DZAP_ZNP_MT=FALSE -DZAP_APP_MSG=FALSE                  #
#                     -DZAP_SBL_PROXY=FALSE -DZAP_AUTO_CFG=TRUE               #
#                     -DZAP_AUTO_START=TRUE -DZAP_NV_RESTORE=FALSE            #
#                     -DLCD_SUPPORTED -DZAP_AF_DATA_REQ_FRAG=FALSE            #
#                     -DZAP_AF_DATA_REQ_AREQ=!ZAP_AF_DATA_REQ_FRAG            #
#                     -DZAP_ZDO_STARTUP_AREQ=TRUE -DZAP_AF_FUNC               #
#                     -DZAP_SAPI_FUNC -DZAP_SYS_FUNC -DZAP_UTIL_FUNC          #
#                     -DZAP_ZDO_FUNC -DSECURE=0 -DZG_SECURE_DYNAMIC=0         #
#                     "-DDEFAULT_CHANLIST=(uint32)0x00000800"                 #
#                     -DZDAPP_CONFIG_PAN_ID=0xFFFF -DPOLL_RATE=1000           #
#                     -DNWK_START_DELAY=100 -DMAX_BINDING_CLUSTER_IDS=4)      #
#                     C:\Users\student\Documents\GitHub\MHMS\MHMS\ZAP-MSP430- #
#                     2.5.1\Projects\zstack\ZAP\Source\zap_zdo.c -lC          #
#                     C:\Users\student\Documents\GitHub\MHMS\MHMS\ZAP-MSP430- #
#                     2.5.1\Projects\zstack\ZAP\TVSA\EXP5438\Routinator\List\ #
#                      -lA C:\Users\student\Documents\GitHub\MHMS\MHMS\ZAP-MS #
#                     P430-2.5.1\Projects\zstack\ZAP\TVSA\EXP5438\Routinator\ #
#                     List\ --remarks --diag_suppress                         #
#                     Pe001,Pe193,Pe236,Pe826 -o                              #
#                     C:\Users\student\Documents\GitHub\MHMS\MHMS\ZAP-MSP430- #
#                     2.5.1\Projects\zstack\ZAP\TVSA\EXP5438\Routinator\Obj\  #
#                     --debug -D__MSP430F5438A__ -e --double=32 --clib -I     #
#                     C:\Users\student\Documents\GitHub\MHMS\MHMS\ZAP-MSP430- #
#                     2.5.1\Projects\zstack\ZAP\TVSA\EXP5438\ -I              #
#                     C:\Users\student\Documents\GitHub\MHMS\MHMS\ZAP-MSP430- #
#                     2.5.1\Projects\zstack\ZAP\TVSA\EXP5438\..\Source\ -I    #
#                     C:\Users\student\Documents\GitHub\MHMS\MHMS\ZAP-MSP430- #
#                     2.5.1\Projects\zstack\ZAP\TVSA\EXP5438\..\..\Source\    #
#                     -I C:\Users\student\Documents\GitHub\MHMS\MHMS\ZAP-MSP4 #
#                     30-2.5.1\Projects\zstack\ZAP\TVSA\EXP5438\..\..\..\..\. #
#                     .\Components\hal\target\MSP5438ZAP\ -I                  #
#                     C:\Users\student\Documents\GitHub\MHMS\MHMS\ZAP-MSP430- #
#                     2.5.1\Projects\zstack\ZAP\TVSA\EXP5438\..\..\..\..\..\C #
#                     omponents\hal\include\ -I C:\Users\student\Documents\Gi #
#                     tHub\MHMS\MHMS\ZAP-MSP430-2.5.1\Projects\zstack\ZAP\TVS #
#                     A\EXP5438\..\..\..\..\..\Components\mac\include\ -I     #
#                     C:\Users\student\Documents\GitHub\MHMS\MHMS\ZAP-MSP430- #
#                     2.5.1\Projects\zstack\ZAP\TVSA\EXP5438\..\..\..\..\..\C #
#                     omponents\mt\ -I C:\Users\student\Documents\GitHub\MHMS #
#                     \MHMS\ZAP-MSP430-2.5.1\Projects\zstack\ZAP\TVSA\EXP5438 #
#                     \..\..\..\..\..\Components\osal\include\ -I             #
#                     C:\Users\student\Documents\GitHub\MHMS\MHMS\ZAP-MSP430- #
#                     2.5.1\Projects\zstack\ZAP\TVSA\EXP5438\..\..\..\..\..\C #
#                     omponents\osal\mcu\msp430\ -I                           #
#                     C:\Users\student\Documents\GitHub\MHMS\MHMS\ZAP-MSP430- #
#                     2.5.1\Projects\zstack\ZAP\TVSA\EXP5438\..\..\..\..\..\C #
#                     omponents\services\saddr\ -I                            #
#                     C:\Users\student\Documents\GitHub\MHMS\MHMS\ZAP-MSP430- #
#                     2.5.1\Projects\zstack\ZAP\TVSA\EXP5438\..\..\..\..\..\C #
#                     omponents\services\sdata\ -I                            #
#                     C:\Users\student\Documents\GitHub\MHMS\MHMS\ZAP-MSP430- #
#                     2.5.1\Projects\zstack\ZAP\TVSA\EXP5438\..\..\..\..\..\C #
#                     omponents\stack\af\ -I C:\Users\student\Documents\GitHu #
#                     b\MHMS\MHMS\ZAP-MSP430-2.5.1\Projects\zstack\ZAP\TVSA\E #
#                     XP5438\..\..\..\..\..\Components\stack\nwk\ -I          #
#                     C:\Users\student\Documents\GitHub\MHMS\MHMS\ZAP-MSP430- #
#                     2.5.1\Projects\zstack\ZAP\TVSA\EXP5438\..\..\..\..\..\C #
#                     omponents\stack\sapi\ -I C:\Users\student\Documents\Git #
#                     Hub\MHMS\MHMS\ZAP-MSP430-2.5.1\Projects\zstack\ZAP\TVSA #
#                     \EXP5438\..\..\..\..\..\Components\stack\sec\ -I        #
#                     C:\Users\student\Documents\GitHub\MHMS\MHMS\ZAP-MSP430- #
#                     2.5.1\Projects\zstack\ZAP\TVSA\EXP5438\..\..\..\..\..\C #
#                     omponents\stack\sys\ -I C:\Users\student\Documents\GitH #
#                     ub\MHMS\MHMS\ZAP-MSP430-2.5.1\Projects\zstack\ZAP\TVSA\ #
#                     EXP5438\..\..\..\..\..\Components\stack\zdo\ -I         #
#                     C:\Users\student\Documents\GitHub\MHMS\MHMS\ZAP-MSP430- #
#                     2.5.1\Projects\zstack\ZAP\TVSA\EXP5438\..\..\..\..\..\C #
#                     omponents\zmac\ -I C:\Users\student\Documents\GitHub\MH #
#                     MS\MHMS\ZAP-MSP430-2.5.1\Projects\zstack\ZAP\TVSA\EXP54 #
#                     38\..\..\..\..\..\Components\zmac\f8w\ --core=430X      #
#                     --data_model=small -Ohz --multiplier=32                 #
#                     --multiplier_location=4C0 --require_prototypes          #
#                     --hw_workaround=CPU40 --hw_workaround=CPU42             #
#    List file     =  C:\Users\student\Documents\GitHub\MHMS\MHMS\ZAP-MSP430- #
#                     2.5.1\Projects\zstack\ZAP\TVSA\EXP5438\Routinator\List\ #
#                     zap_zdo.lst                                             #
#    Object file   =  C:\Users\student\Documents\GitHub\MHMS\MHMS\ZAP-MSP430- #
#                     2.5.1\Projects\zstack\ZAP\TVSA\EXP5438\Routinator\Obj\z #
#                     ap_zdo.r43                                              #
#                                                                             #
#                                                                             #
###############################################################################

C:\Users\student\Documents\GitHub\MHMS\MHMS\ZAP-MSP430-2.5.1\Projects\zstack\ZAP\Source\zap_zdo.c
      1          /**************************************************************************************************
      2              Filename:       zap_zdo.c
      3              Revised:        $Date: 2011-06-07 11:43:24 -0700 (Tue, 07 Jun 2011) $
      4              Revision:       $Revision: 26237 $
      5          
      6              Description:
      7          
      8              This file declares the ZNP Application Processor proxy ZDO API functions.
      9          
     10          
     11              Copyright 2009-2011 Texas Instruments Incorporated. All rights reserved.
     12          
     13              IMPORTANT: Your use of this Software is limited to those specific rights
     14              granted under the terms of a software license agreement between the user
     15              who downloaded the software, his/her employer (which must be your employer)
     16              and Texas Instruments Incorporated (the "License").  You may not use this
     17              Software unless you agree to abide by the terms of the License. The License
     18              limits your use, and you acknowledge, that the Software may not be modified,
     19              copied or distributed unless embedded on a Texas Instruments microcontroller
     20              or used solely and exclusively in conjunction with a Texas Instruments radio
     21              frequency transceiver, which is integrated into your product.  Other than for
     22              the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     23              works of, modify, distribute, perform, display or sell this Software and/or
     24              its documentation for any purpose.
     25          
     26              YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     27              PROVIDED “AS IS” WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,
     28              INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE,
     29              NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     30              TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     31              NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     32              LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     33              INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     34              OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     35              OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     36              (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     37          
     38              Should you have any questions regarding your right to use this Software,
     39              contact Texas Instruments Incorporated at www.TI.com.
     40          **************************************************************************************************/
     41          
     42          /* ------------------------------------------------------------------------------------------------
     43           *                                          Includes
     44           * ------------------------------------------------------------------------------------------------
     45           */
     46          
     47          #include "mt.h"
     48          #include "mt_rpc.h"
     49          #include "OSAL.h"
     50          #include "sapi.h"
     51          #include "zap_app.h"
     52          #include "zap_phy.h"
     53          #include "zap_znp.h"
     54          #include "ZComDef.h"
     55          #include "ZDApp.h"
     56          #include "ZDObject.h"
     57          
     58          #if defined (ZAP_ZDO_FUNC)
     59          /* ------------------------------------------------------------------------------------------------
     60           *                                           Constants
     61           * ------------------------------------------------------------------------------------------------
     62           */
     63          
     64          /* ------------------------------------------------------------------------------------------------
     65           *                                           Typedefs
     66           * ------------------------------------------------------------------------------------------------
     67           */
     68          
     69          typedef struct
     70          {
     71            void *next;
     72            uint8 taskID;
     73            uint16 clusterID;
     74          } ZDO_MsgCB_t;
     75          
     76          /* ------------------------------------------------------------------------------------------------
     77           *                                           Macros
     78           * ------------------------------------------------------------------------------------------------
     79           */
     80          
     81          /* ------------------------------------------------------------------------------------------------
     82           *                                           Global Variables
     83           * ------------------------------------------------------------------------------------------------
     84           */
     85          
     86          /* ------------------------------------------------------------------------------------------------
     87           *                                           Local Variables
     88           * ------------------------------------------------------------------------------------------------
     89           */
     90          

   \                                 In  segment DATA16_Z, align 2, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
     91          static ZDO_MsgCB_t *zdoMsgCBs = (ZDO_MsgCB_t *)NULL;
   \                     zdoMsgCBs:
   \   000000                DS8 2

   \                                 In  segment DATA16_Z, align 2, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
     92          static pfnZdoCb zdoCBFunc[MAX_ZDO_CB_FUNC];
   \                     zdoCBFunc:
   \   000000                DS8 28
     93          
     94          /* ------------------------------------------------------------------------------------------------
     95           *                                           Local Functions
     96           * ------------------------------------------------------------------------------------------------
     97           */
     98          
     99          static void zapZDO_ConcentratorIndicationCB(uint8 *pBuf);
    100          static void ZDO_SendMsgCBs(zdoIncomingMsg_t *inMsg);
    101          
    102          /**************************************************************************************************
    103           * @fn          zapZdoProcessIncoming
    104           *
    105           * @brief       This function processes the ZDO sub-system response from the ZNP.
    106           *
    107           * input parameters
    108           *
    109           * @param       port - Port Id corresponding to the ZNP that sent the message.
    110           * @param       pBuf - A pointer to the RPC response.
    111           *
    112           * output parameters
    113           *
    114           * None.
    115           *
    116           * @return      None.
    117           **************************************************************************************************
    118           */

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine12:
   \   000000   3D400004     MOV.W   #0x400, R13
   \   000004                REQUIRE ??Subroutine12_0
   \   000004                // Fall through to label ??Subroutine12_0

   \                                 In  segment CODE, align 2
   \                     ??Subroutine12_0:
   \   000000   5C42....     MOV.B   &zapTaskId, R12
   \   000004   ........     BRA     #osal_set_event

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine11:
   \   000000   6E4D         MOV.B   @R13, R14
   \   000002   5F4D0100     MOV.B   0x1(R13), R15
   \   000006                REQUIRE ??Subroutine11_0
   \   000006                // Fall through to label ??Subroutine11_0

   \                                 In  segment CODE, align 2
   \                     ??Subroutine11_0:
   \   000000                RPT     #0x8
   \   000000   47180F5F     RLAX.W  R15
   \   000004   0E5F         ADD.W   R15, R14
   \   000006   1001         RETA

   \                                 In  segment CODE, align 2
   \                     ?Subroutine13:
   \   000000   5C42....     MOV.B   &zapTaskId, R12
   \   000004   ........     CALLA   #osal_start_timerEx
   \   000008   4C93         CMP.B   #0x0, R12
   \   00000A   1001         RETA

   \                                 In  segment CODE, align 2
    119          void zapZdoProcessIncoming(uint8 port, uint8 *pBuf)
   \                     zapZdoProcessIncoming:
    120          {
   \   000000   31801800     SUB.W   #0x18, SP
    121            uint8 len = pBuf[MT_RPC_POS_LEN];
   \   000004   6C4D         MOV.B   @R13, R12
    122            uint8 cmd1 = pBuf[MT_RPC_POS_CMD1];
   \   000006   5E4D0200     MOV.B   0x2(R13), R14
    123          
    124            pBuf += MT_RPC_FRAME_HDR_SZ;
   \   00000A   3D500300     ADD.W   #0x3, R13
    125          
    126            switch (cmd1)
   \   00000E   7E80C000     SUB.B   #0xc0, R14
   \   000012   0624         JEQ     ??zapZdoProcessIncoming_0
   \   000014   7E82         SUB.B   #0x8, R14
   \   000016   0E24         JEQ     ??zapZdoProcessIncoming_1
   \   000018   7E803700     SUB.B   #0x37, R14
   \   00001C   0F24         JEQ     ??zapZdoProcessIncoming_2
   \   00001E   2F3C         JMP     ??zapZdoProcessIncoming_3
    127            {
    128            case MT_ZDO_STATUS_ERROR_RSP:  // TODO: fill-in when/if needed.
    129              break;
    130          
    131            case MT_ZDO_STATE_CHANGE_IND:
    132              // Especially for UART transport, allow time for multiple got syncs before acting on it.
    133              if (ZSuccess != osal_start_timerEx(zapTaskId, ZAP_APP_ZDO_STATE_CHANGE_EVT,
    134                                                            ZAP_APP_ZDO_STATE_CHANGE_DLY))
   \                     ??zapZdoProcessIncoming_0:
   \   000020   3E406400     MOV.W   #0x64, R14
   \   000024   3D400004     MOV.W   #0x400, R13
   \   000028   ........     CALLA   #?Subroutine13
   \                     ??CrossCallReturnLabel_10:
   \   00002C   2824         JEQ     ??zapZdoProcessIncoming_3
    135              {
    136                (void)osal_set_event(zapTaskId, ZAP_APP_ZDO_STATE_CHANGE_EVT);
   \   00002E   ........     CALLA   #?Subroutine12
    137              }
   \                     ??CrossCallReturnLabel_22:
   \   000032   253C         JMP     ??zapZdoProcessIncoming_3
    138              break;
    139          
    140            case MT_ZDO_MATCH_DESC_RSP_SENT:  // TODO: fill-in when/if needed.
    141              break;
    142          
    143            case MT_ZDO_SRC_RTG_IND:  // TODO: fill-in when/if needed.
    144              break;
    145          
    146            case MT_ZDO_JOIN_CNF:  // TODO: fill-in when/if needed.
    147              break;
    148          
    149            case MT_ZDO_CONCENTRATOR_IND_CB:
    150              zapZDO_ConcentratorIndicationCB(pBuf);
   \                     ??zapZdoProcessIncoming_1:
   \   000034   0C4D         MOV.W   R13, R12
   \   000036   ........     CALLA   #zapZDO_ConcentratorIndicationCB
    151              break;
   \   00003A   213C         JMP     ??zapZdoProcessIncoming_3
    152          
    153            case MT_ZDO_MSG_CB_INCOMING:
    154              {
    155                zdoIncomingMsg_t inMsg;
    156          
    157                // Assuming exclusive use of network short addresses.
    158                inMsg.srcAddr.addrMode = Addr16Bit;
   \                     ??zapZdoProcessIncoming_2:
   \   00003C   E1430A00     MOV.B   #0x2, 0xa(SP)
    159                inMsg.srcAddr.addr.shortAddr = BUILD_UINT16(pBuf[0], pBuf[1]);
   \   000040   ........     CALLA   #?Subroutine11
   \                     ??CrossCallReturnLabel_27:
   \   000044   814E0200     MOV.W   R14, 0x2(SP)
    160                pBuf += 2;
   \   000048   2D53         ADD.W   #0x2, R13
    161                inMsg.wasBroadcast = *pBuf++;
   \   00004A   F14D0C00     MOV.B   @R13+, 0xc(SP)
    162                inMsg.clusterID = BUILD_UINT16(pBuf[0], pBuf[1]);
   \   00004E   ........     CALLA   #?Subroutine11
   \                     ??CrossCallReturnLabel_28:
   \   000052   814E0E00     MOV.W   R14, 0xe(SP)
    163                pBuf += 2;
   \   000056   2D53         ADD.W   #0x2, R13
    164                inMsg.SecurityUse = *pBuf++;
   \   000058   F14D1000     MOV.B   @R13+, 0x10(SP)
    165                inMsg.TransSeq = *pBuf++;
   \   00005C   F14D1100     MOV.B   @R13+, 0x11(SP)
    166                inMsg.asduLen = len-9;
   \   000060   7C50F700     ADD.B   #0xf7, R12
   \   000064   C14C1200     MOV.B   R12, 0x12(SP)
    167                inMsg.macDestAddr = BUILD_UINT16(pBuf[0], pBuf[1]);
   \   000068   ........     CALLA   #?Subroutine11
   \                     ??CrossCallReturnLabel_29:
   \   00006C   814E1400     MOV.W   R14, 0x14(SP)
    168                pBuf += 2;
    169                inMsg.asdu = pBuf;
   \   000070   2D53         ADD.W   #0x2, R13
   \   000072   814D1600     MOV.W   R13, 0x16(SP)
    170          
    171                ZDO_SendMsgCBs(&inMsg);
   \   000076   0C41         MOV.W   SP, R12
   \   000078   0C53         ADD.W   #0x0, R12
   \   00007A   ........     CALLA   #ZDO_SendMsgCBs
    172              }
    173              break;
    174          
    175            default:
    176              break;
    177            }
    178          }
   \                     ??zapZdoProcessIncoming_3:
   \   00007E   31501800     ADD.W   #0x18, SP
   \   000082   1001         RETA
    179          
    180          /**************************************************************************************************
    181           * @fn          zapZdoSync
    182           *
    183           * @brief       This function syncs the ZDO registered callbacks (which are not NV restored on ZNP.)
    184           *
    185           * input parameters
    186           *
    187           * None.
    188           *
    189           * output parameters
    190           *
    191           * None.
    192           *
    193           * @return      None.
    194           **************************************************************************************************
    195           */

   \                                 In  segment CODE, align 2
    196          void zapZdoSync(void)
   \                     zapZdoSync:
    197          {
   \   000000   0A12         PUSH.W  R10
    198            ZDO_MsgCB_t *pCB = zdoMsgCBs;
   \   000002   1A42....     MOV.W   &zdoMsgCBs, R10
   \   000006   123C         JMP     ??zapZdoSync_1
    199          
    200            while (pCB)
    201            {
    202              if (znp_ZDO_RegisterForZDOMsg(pCB->clusterID) != ZSuccess)
   \                     ??zapZdoSync_0:
   \   000008   1C4A0400     MOV.W   0x4(R10), R12
   \   00000C   ........     CALLA   #znp_ZDO_RegisterForZDOMsg
   \   000010   4C93         CMP.B   #0x0, R12
   \   000012   0B24         JEQ     ??zapZdoSync_2
    203              {
    204                // Especially for UART transport, allow time for multiple got syncs before acting on it.
    205                if (ZSuccess != osal_start_timerEx(zapTaskId, ZAP_APP_SYNC_EVT, ZAP_APP_SYNC_DLY))
   \   000014   3E406400     MOV.W   #0x64, R14
   \   000018   3D400008     MOV.W   #0x800, R13
   \   00001C   ........     CALLA   #?Subroutine13
   \                     ??CrossCallReturnLabel_9:
   \   000020   0424         JEQ     ??zapZdoSync_2
    206                {
    207                  (void)osal_set_event(zapTaskId, ZAP_APP_SYNC_EVT);
   \   000022   3D400008     MOV.W   #0x800, R13
   \   000026   ........     CALLA   #??Subroutine12_0
    208                }
    209              }
    210              pCB = (ZDO_MsgCB_t *)pCB->next;
   \                     ??zapZdoSync_2:
   \   00002A   2A4A         MOV.W   @R10, R10
    211            }
   \                     ??zapZdoSync_1:
   \   00002C   0A93         CMP.W   #0x0, R10
   \   00002E   EC23         JNE     ??zapZdoSync_0
    212          }
   \   000030   3A41         POP.W   R10
   \   000032   1001         RETA
    213          
    214          
    215          /* ------------------------------------------------------------------------------------------------
    216           *                                     ZDApp Proxy
    217           * ------------------------------------------------------------------------------------------------
    218           */
    219          
    220          /*********************************************************************
    221           * @fn      ZDOInitDevice
    222           *
    223           * @brief   Start the device in the network.  This function will read
    224           *   ZCD_NV_STARTUP_OPTION (NV item) to determine whether or not to
    225           *   restore the network state of the device.
    226           *
    227           * @param   startDelay - timeDelay to start device (in milliseconds).
    228           *      There is a jitter added to this delay:
    229           *              ((NWK_START_DELAY + startDelay)
    230           *              + (osal_rand() & EXTENDED_JOINING_RANDOM_MASK))
    231           *
    232           * NOTE:    If the application would like to force a "new" join, the
    233           *          application should set the ZCD_STARTOPT_DEFAULT_NETWORK_STATE
    234           *          bit in the ZCD_NV_STARTUP_OPTION NV item before calling
    235           *          this function. "new" join means to not restore the network
    236           *          state of the device. Use zgWriteStartupOptions() to set these
    237           *          options.
    238           *
    239           * @return
    240           *    ZDO_INITDEV_RESTORED_NETWORK_STATE  - The device's network state was
    241           *          restored.
    242           *    ZDO_INITDEV_NEW_NETWORK_STATE - The network state was initialized.
    243           *          This could mean that ZCD_NV_STARTUP_OPTION said to not restore, or
    244           *          it could mean that there was no network state to restore.
    245           *    ZDO_INITDEV_LEAVE_NOT_STARTED - Before the reset, a network leave was issued
    246           *          with the rejoin option set to TRUE.  So, the device was not
    247           *          started in the network (one time only).  The next time this
    248           *          function is called it will start.
    249           *    0xFF for failure.
    250           */

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ??Subroutine16_0:
   \   000000   5C42....     MOV.B   &zapAppPort, R12
   \   000004   ........     BRA     #zapPhySend

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine15:
   \   000000   ........     CALLA   #zap_msg_allocate
   \   000004   814C0400     MOV.W   R12, 0x4(SP)
   \   000008   0C93         CMP.W   #0x0, R12
   \   00000A   1001         RETA

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine6:
   \   000000   0C41         MOV.W   SP, R12
   \   000002   2C52         ADD.W   #0x4, R12
   \   000004   ........     BRA     #zap_msg_deallocate

   \                                 In  segment CODE, align 2
    251          uint8 ZDOInitDevice(uint16 startDelay)
   \                     ZDOInitDevice:
    252          {
   \   000000   2183         SUB.W   #0x2, SP
    253            uint8 *pBuf;
    254          #if !ZAP_ZDO_STARTUP_AREQ
    255            uint8 rtrn;
    256          #endif
    257          
    258            (void)startDelay;  // ZNP MT_ZDO_STARTUP_FROM_APP processing forces delay 0.
    259          
    260            zb_GetDeviceInfo(ZB_INFO_DEV_STATE, &devState);
   \   000002   3D40....     MOV.W   #devState, R13
   \   000006   4C43         MOV.B   #0x0, R12
   \   000008   ........     CALLA   #zb_GetDeviceInfo
    261            if ((DEV_HOLD != devState) && (DEV_INIT != devState) && (DEV_NWK_ORPHAN != devState))
   \   00000C   5E42....     MOV.B   &devState, R14
   \   000010   4E93         CMP.B   #0x0, R14
   \   000012   0524         JEQ     ??ZDOInitDevice_0
   \   000014   5E93         CMP.B   #0x1, R14
   \   000016   0324         JEQ     ??ZDOInitDevice_0
   \   000018   7E900A00     CMP.B   #0xa, R14
   \   00001C   1C20         JNE     ??ZDOInitDevice_1
    262            {
    263              return FAILURE;
    264            }
    265          
    266          #if ZAP_ZDO_STARTUP_AREQ
    267            pBuf = zap_msg_allocate(0, (uint8)MT_RPC_SYS_ZDO | (uint8)MT_RPC_CMD_AREQ,
    268                                       (uint8)MT_ZDO_STARTUP_FROM_APP);
   \                     ??ZDOInitDevice_0:
   \   00001E   7E404000     MOV.B   #0x40, R14
   \   000022   7D404500     MOV.B   #0x45, R13
   \   000026   4C43         MOV.B   #0x0, R12
   \   000028   ........     CALLA   #?Subroutine15
    269          #else
    270            pBuf = zap_msg_allocate(0, (uint8)MT_RPC_SYS_ZDO | (uint8)MT_RPC_CMD_SREQ,
    271                                       (uint8)MT_ZDO_STARTUP_FROM_APP);
    272          #endif
    273          
    274            if (NULL == pBuf)
   \                     ??CrossCallReturnLabel_18:
   \   00002C   0220         JNE     ??ZDOInitDevice_2
    275            {
    276              return 0xFF;
   \   00002E   7C43         MOV.B   #0xff, R12
   \   000030   133C         JMP     ??ZDOInitDevice_3
    277            }
    278          
    279            zapPhySend(zapAppPort, pBuf);
   \                     ??ZDOInitDevice_2:
   \   000032   0D4C         MOV.W   R12, R13
   \   000034   ........     CALLA   #??Subroutine16_0
    280          #if !ZAP_ZDO_STARTUP_AREQ
    281            if (ZSuccess == (rtrn = ZAP_SRSP_STATUS(pBuf)))
    282          #endif
    283            // Need to locally enter the discovery state to holdoff calls to ZDOInitDevice() until the ZAP
    284            // monitoring task requests the actual ZNP state.
    285            devState = DEV_NWK_DISC;
   \                     ??CrossCallReturnLabel_19:
   \   000038   E243....     MOV.B   #0x2, &devState
    286            zap_msg_deallocate(&pBuf);
   \   00003C   ........     CALLA   #?Subroutine6
    287          
    288            // Joining can take some time - especially with > 1 scan channel.
    289            if (ZSuccess != osal_start_timerEx(zapTaskId, ZAP_APP_TMR_EVT, ZAP_APP_JOIN_DLY))
   \                     ??CrossCallReturnLabel_0:
   \   000040   3E401027     MOV.W   #0x2710, R14
   \   000044   3D400010     MOV.W   #0x1000, R13
   \   000048   ........     CALLA   #?Subroutine13
   \                     ??CrossCallReturnLabel_8:
   \   00004C   0424         JEQ     ??ZDOInitDevice_1
    290            {
    291              (void)osal_set_event(zapTaskId, ZAP_APP_TMR_EVT);
   \   00004E   3D400010     MOV.W   #0x1000, R13
   \   000052   ........     CALLA   #??Subroutine12_0
    292            }
    293          
    294          #if ZAP_ZDO_STARTUP_AREQ
    295            // Made into an AREQ after empirical results showed > 400 msec delay on SRSP.
    296          #if ZAP_NV_RESTORE
    297            return ZDO_INITDEV_RESTORED_NETWORK_STATE;
    298          #else
    299            return ZDO_INITDEV_NEW_NETWORK_STATE;
   \                     ??ZDOInitDevice_1:
   \   000056   5C43         MOV.B   #0x1, R12
   \                     ??ZDOInitDevice_3:
   \   000058   2153         ADD.W   #0x2, SP
   \   00005A   1001         RETA
    300          #endif
    301          #else
    302            return rtrn;
    303          #endif
    304          }
    305          
    306          /*********************************************************************
    307           * @fn          ZDO_ConcentratorIndicationCB
    308           *
    309           * @brief       This function allows the next higher layer of a
    310           *              device to be notified of existence of the concentrator.
    311           *
    312           * @param       nwkAddr - 16-bit NWK address of the concentrator
    313           * @param       extAddr - pointer to extended Address
    314           *                        NULL if not available
    315           * @param       pktCost - PktCost from RREQ
    316           *
    317           * @return      void
    318           */

   \                                 In  segment CODE, align 2
    319          static void zapZDO_ConcentratorIndicationCB(uint8 *pBuf)
   \                     zapZDO_ConcentratorIndicationCB:
    320          {
   \   000000   31800600     SUB.W   #0x6, SP
    321            if (zdoCBFunc[ZDO_CONCENTRATOR_IND_CBID] != NULL)
   \   000004   1F42....     MOV.W   &zdoCBFunc + 4, R15
   \   000008   1FD2....     BIS.W   &zdoCBFunc + 6, R15
   \   00000C   0F93         CMP.W   #0x0, R15
   \   00000E   1124         JEQ     ??zapZDO_ConcentratorIndicationCB_0
    322            {
    323              zdoConcentratorInd_t conInd;
    324          
    325              conInd.nwkAddr = BUILD_UINT16(pBuf[0], pBuf[1]);
   \   000010   6E4C         MOV.B   @R12, R14
   \   000012   5F4C0100     MOV.B   0x1(R12), R15
   \   000016   ........     CALLA   #??Subroutine11_0
   \                     ??CrossCallReturnLabel_26:
   \   00001A   814E0000     MOV.W   R14, 0(SP)
    326              pBuf += 2;
    327              conInd.extAddr = pBuf;
   \   00001E   2C53         ADD.W   #0x2, R12
   \   000020   814C0200     MOV.W   R12, 0x2(SP)
    328              pBuf += Z_EXTADDR_LEN;
    329              conInd.pktCost = *pBuf;
   \   000024   D14C08000400 MOV.B   0x8(R12), 0x4(SP)
    330              zdoCBFunc[ZDO_CONCENTRATOR_IND_CBID]((void *)&conInd);
   \   00002A   0C41         MOV.W   SP, R12
   \   00002C   0C53         ADD.W   #0x0, R12
   \   00002E   ........     CALLA   &zdoCBFunc + 4
    331            }
    332          }
   \                     ??zapZDO_ConcentratorIndicationCB_0:
   \   000032   31500600     ADD.W   #0x6, SP
   \   000036   1001         RETA
    333          
    334          /*********************************************************************
    335           * @fn          ZDO_RegisterForZdoCB
    336           *
    337           * @brief       Call this function to register the higher layer (for
    338           *              example, the Application layer or MT layer) with ZDO
    339           *              callbacks to get notified of some ZDO indication like
    340           *              existence of a concentrator or receipt of a source
    341           *              route record.
    342           *
    343           * @param       indID - ZDO Indication ID
    344           * @param       pFn   - Callback function pointer
    345           *
    346           * @return      ZSuccess - successful, ZInvalidParameter if not
    347           */

   \                                 In  segment CODE, align 2
    348          ZStatus_t ZDO_RegisterForZdoCB( uint8 indID, pfnZdoCb pFn )
   \                     ZDO_RegisterForZdoCB:
    349          {
    350            // Check the range of the indication ID
    351            if ( indID < MAX_ZDO_CB_FUNC )
   \   000000   7C900700     CMP.B   #0x7, R12
   \   000004   082C         JC      ??ZDO_RegisterForZdoCB_0
    352            {
    353              zdoCBFunc[indID] = pFn;
   \   000006   4C4C         MOV.B   R12, R12
   \   000008   5C06         RLAM.W  #0x2, R12
   \   00000A   8C4E....     MOV.W   R14, zdoCBFunc(R12)
   \   00000E   8C4F....     MOV.W   R15, zdoCBFunc + 2(R12)
    354              return ZSuccess;
   \   000012   4C43         MOV.B   #0x0, R12
   \   000014   1001         RETA
    355            }
    356          
    357            return ZInvalidParameter;
   \                     ??ZDO_RegisterForZdoCB_0:
   \   000016   6C43         MOV.B   #0x2, R12
   \   000018   1001         RETA
    358          }
    359          
    360          
    361          /* ------------------------------------------------------------------------------------------------
    362           *                                     ZDObject Proxy
    363           * ------------------------------------------------------------------------------------------------
    364           */
    365          
    366          /**************************************************************************************************
    367           * @fn          ZDO_UpdateNwkStatus
    368           *
    369           * @brief       This function sends a ZDO_STATE_CHANGE message to the task of every EndPoint
    370           *              registered with AF (except, of course, the ZDO_EP). Even if a single task has more
    371           *              than one registered EndPoint, it will only receive one notification per state
    372           *              change. Although the device may go through a sequence of state changes, the
    373           *              Application task may only receive notification of the final, steady-state state
    374           *              because it has the lowest priority and never even runs to receive the intermediate
    375           *              state change notifications.
    376           *
    377           * input parameters
    378           *
    379           * @param       state - The current device state.
    380           *
    381           * output parameters
    382           *
    383           * None.
    384           *
    385           * @return      None.
    386           **************************************************************************************************
    387           */

   \                                 In  segment CODE, align 2
    388          void ZDO_UpdateNwkStatus(devStates_t state)
   \                     ZDO_UpdateNwkStatus:
    389          {
   \   000000   1B15         PUSHM.W #0x2, R11
   \   000002   4A4C         MOV.B   R12, R10
    390            epList_t *pItem = epList;
   \   000004   1B42....     MOV.W   &epList, R11
   \   000008   033C         JMP     ??ZDO_UpdateNwkStatus_2
    391          
    392            while (pItem != NULL)
    393            {
    394              if (pItem->epDesc->endPoint != ZDO_EP)
    395              {
    396                osal_event_hdr_t *pMsg = (osal_event_hdr_t *)osal_msg_find(*(pItem->epDesc->task_id),
    397                                                                                   ZDO_STATE_CHANGE);
    398          
    399                if (NULL == pMsg)
    400                {
    401                  if (NULL == (pMsg = (osal_event_hdr_t *)osal_msg_allocate(sizeof(osal_event_hdr_t))))
    402                  {
    403                    // Upon failure to notify any EndPoint of the state change, re-set the ZDO event to
    404                    // try again later when more Heap may be available.
    405                    osal_set_event(zapTaskId, ZAP_APP_ZDO_STATE_CHANGE_EVT);
    406                  }
    407                  else
    408                  {
    409                    pMsg->event = ZDO_STATE_CHANGE;
    410                    pMsg->status = (uint8)state;
    411          
    412                    (void)osal_msg_send(*(pItem->epDesc->task_id), (uint8 *)pMsg);
    413                  }
    414                }
    415                else
    416                {
    417                  // Modify in place the status of an existing ZDO_STATE_CHANGE message to the EndPoint.
    418                  pMsg->status = (uint8)state;
   \                     ??ZDO_UpdateNwkStatus_1:
   \   00000A   CC4A0100     MOV.B   R10, 0x1(R12)
    419                }
    420              }
    421          
    422              pItem = pItem->nextDesc;
   \                     ??ZDO_UpdateNwkStatus_0:
   \   00000E   2B4B         MOV.W   @R11, R11
   \                     ??ZDO_UpdateNwkStatus_2:
   \   000010   0B93         CMP.W   #0x0, R11
   \   000012   2424         JEQ     ??ZDO_UpdateNwkStatus_3
   \   000014   1F4B0200     MOV.W   0x2(R11), R15
   \   000018   CF930000     CMP.B   #0x0, 0(R15)
   \   00001C   F827         JEQ     ??ZDO_UpdateNwkStatus_0
   \   00001E   7D40D100     MOV.B   #0xd1, R13
   \   000022   1F4F0200     MOV.W   0x2(R15), R15
   \   000026   6C4F         MOV.B   @R15, R12
   \   000028   ........     CALLA   #osal_msg_find
   \   00002C   0C93         CMP.W   #0x0, R12
   \   00002E   ED23         JNE     ??ZDO_UpdateNwkStatus_1
   \   000030   2C43         MOV.W   #0x2, R12
   \   000032   ........     CALLA   #osal_msg_allocate
   \   000036   0D4C         MOV.W   R12, R13
   \   000038   0C93         CMP.W   #0x0, R12
   \   00003A   0320         JNE     ??ZDO_UpdateNwkStatus_4
   \   00003C   ........     CALLA   #?Subroutine12
   \                     ??CrossCallReturnLabel_23:
   \   000040   E63F         JMP     ??ZDO_UpdateNwkStatus_0
   \                     ??ZDO_UpdateNwkStatus_4:
   \   000042   FC40D1000000 MOV.B   #0xd1, 0(R12)
   \   000048   CC4A0100     MOV.B   R10, 0x1(R12)
   \   00004C   1F4B0200     MOV.W   0x2(R11), R15
   \   000050   1F4F0200     MOV.W   0x2(R15), R15
   \   000054   6C4F         MOV.B   @R15, R12
   \   000056   ........     CALLA   #osal_msg_send
   \   00005A   D93F         JMP     ??ZDO_UpdateNwkStatus_0
    423            }
    424          }
   \                     ??ZDO_UpdateNwkStatus_3:
   \   00005C   1A17         POPM.W  #0x2, R11
   \   00005E   1001         RETA
    425          
    426          /*********************************************************************
    427           * @fn          ZDO_ParseDeviceAnnce
    428           *
    429           * @brief       Parse a Device Announce message.
    430           *
    431           * @param       inMsg - Incoming message
    432           * @param       pAnnce - place to put the parsed information
    433           *
    434           * @return      none
    435           */

   \                                 In  segment CODE, align 2
    436          void ZDO_ParseDeviceAnnce( zdoIncomingMsg_t *inMsg, ZDO_DeviceAnnce_t *pAnnce )
   \                     ZDO_ParseDeviceAnnce:
    437          {
   \   000000   1B15         PUSHM.W #0x2, R11
   \   000002   0A4D         MOV.W   R13, R10
    438            uint8 *msg;
    439          
    440            // Parse incoming message
    441            msg = inMsg->asdu;
   \   000004   1B4C1600     MOV.W   0x16(R12), R11
    442            pAnnce->nwkAddr = BUILD_UINT16( msg[0], msg[1] );
   \   000008   6E4B         MOV.B   @R11, R14
   \   00000A   5F4B0100     MOV.B   0x1(R11), R15
   \   00000E   ........     CALLA   #??Subroutine11_0
   \                     ??CrossCallReturnLabel_25:
   \   000012   8D4E0000     MOV.W   R14, 0(R13)
    443            msg += 2;
   \   000016   2B53         ADD.W   #0x2, R11
    444            osal_cpyExtAddr( pAnnce->extAddr, msg );
   \   000018   0D4B         MOV.W   R11, R13
   \   00001A   0C4A         MOV.W   R10, R12
   \   00001C   2C53         ADD.W   #0x2, R12
   \   00001E   ........     CALLA   #sAddrExtCpy
    445            msg += Z_EXTADDR_LEN;
    446            pAnnce->capabilities = *msg;
   \   000022   DA4B08000A00 MOV.B   0x8(R11), 0xa(R10)
    447          }
   \   000028   1A17         POPM.W  #0x2, R11
   \   00002A   1001         RETA
    448          
    449          /*********************************************************************
    450           * @fn          ZDO_ParseSimpleDescRsp
    451           *
    452           * @brief       This function parse the Simple_Desc_rsp message.
    453           *
    454           *   NOTE: The pAppInClusterList and pAppOutClusterList fields
    455           *         in the SimpleDescriptionFormat_t structure are allocated
    456           *         and the calling function needs to free [osal_msg_free()]
    457           *         these buffers.
    458           *
    459           * @param       inMsg  - incoming message
    460           * @param       pSimpleDescRsp - place to parse the message into
    461           *
    462           * @return      none
    463           */

   \                                 In  segment CODE, align 2
    464          void ZDO_ParseSimpleDescRsp( zdoIncomingMsg_t *inMsg, ZDO_SimpleDescRsp_t *pSimpleDescRsp )
   \                     ZDO_ParseSimpleDescRsp:
    465          {
    466            uint8 *msg;
    467          
    468            msg = inMsg->asdu;
   \   000000   1C4C1600     MOV.W   0x16(R12), R12
    469            pSimpleDescRsp->status = *msg++;
   \   000004   FD4C0000     MOV.B   @R12+, 0(R13)
    470            pSimpleDescRsp->nwkAddr = BUILD_UINT16( msg[0], msg[1] );
   \   000008   6E4C         MOV.B   @R12, R14
   \   00000A   5F4C0100     MOV.B   0x1(R12), R15
   \   00000E   ........     CALLA   #??Subroutine11_0
   \                     ??CrossCallReturnLabel_24:
   \   000012   8D4E0200     MOV.W   R14, 0x2(R13)
    471            msg += sizeof ( uint16 );
    472            msg++; // Skip past the length field.
    473          
    474            if ( pSimpleDescRsp->status == ZDP_SUCCESS )
   \   000016   CD930000     CMP.B   #0x0, 0(R13)
   \   00001A   0520         JNE     ??ZDO_ParseSimpleDescRsp_0
    475            {
    476              ZDO_ParseSimpleDescBuf( msg, &(pSimpleDescRsp->simpleDesc) );
   \   00001C   2D52         ADD.W   #0x4, R13
   \   00001E   3C500300     ADD.W   #0x3, R12
   \   000022   ........     CALLA   #ZDO_ParseSimpleDescBuf
    477            }
    478          }
   \                     ??ZDO_ParseSimpleDescRsp_0:
   \   000026   1001         RETA
    479          
    480          /*********************************************************************
    481           * @fn          ZDO_ParseEPListRsp
    482           *
    483           * @brief       This parse the Active_EP_rsp or Match_Desc_rsp message.
    484           *
    485           * @param       inMsg  - incoming message
    486           *
    487           * @return      none
    488           */

   \                                 In  segment CODE, align 2
    489          ZDO_ActiveEndpointRsp_t *ZDO_ParseEPListRsp( zdoIncomingMsg_t *inMsg )
   \                     ZDO_ParseEPListRsp:
    490          {
   \   000000   5B15         PUSHM.W #0x6, R11
    491            ZDO_ActiveEndpointRsp_t *pRsp;
    492            uint8 *msg;
    493            uint8 Status;
    494            uint8 cnt;
    495          
    496            msg = inMsg->asdu;
   \   000002   184C1600     MOV.W   0x16(R12), R8
    497            Status = *msg++;
   \   000006   7648         MOV.B   @R8+, R6
    498            cnt = msg[2];
   \   000008   5A480200     MOV.B   0x2(R8), R10
    499          
    500            pRsp = (ZDO_ActiveEndpointRsp_t *)osal_mem_alloc( sizeof(  ZDO_ActiveEndpointRsp_t ) + cnt );
   \   00000C   4B4A         MOV.B   R10, R11
   \   00000E   0C4B         MOV.W   R11, R12
   \   000010   3C500600     ADD.W   #0x6, R12
   \   000014   ........     CALLA   #osal_mem_alloc
   \   000018   094C         MOV.W   R12, R9
    501            if ( pRsp )
   \   00001A   0C93         CMP.W   #0x0, R12
   \   00001C   1024         JEQ     ??ZDO_ParseEPListRsp_0
    502            {
    503              pRsp->status = Status;
   \   00001E   CC460000     MOV.B   R6, 0(R12)
    504              pRsp->nwkAddr = BUILD_UINT16( msg[0], msg[1] );
   \   000022   ........     CALLA   #?Subroutine10
   \                     ??CrossCallReturnLabel_7:
   \   000026   8C4E0200     MOV.W   R14, 0x2(R12)
    505              msg += sizeof( uint16 );
    506              pRsp->cnt = cnt;
   \   00002A   CC4A0400     MOV.B   R10, 0x4(R12)
    507              msg++; // pass cnt
    508              osal_memcpy( pRsp->epList, msg, cnt );
   \   00002E   0E4B         MOV.W   R11, R14
   \   000030   38500300     ADD.W   #0x3, R8
   \   000034   0D48         MOV.W   R8, R13
   \   000036   3C500500     ADD.W   #0x5, R12
   \   00003A   ........     CALLA   #osal_memcpy
    509            }
    510          
    511            return ( pRsp );
   \                     ??ZDO_ParseEPListRsp_0:
   \   00003E   0C49         MOV.W   R9, R12
   \   000040   5617         POPM.W  #0x6, R11
   \   000042   1001         RETA
    512          }

   \                                 In  segment CODE, align 2
   \                     ?Subroutine10:
   \   000000   6E48         MOV.B   @R8, R14
   \   000002   ........     CALLA   #?Subroutine14
   \                     ??CrossCallReturnLabel_13:
   \   000006   0E5F         ADD.W   R15, R14
   \   000008   1001         RETA

   \                                 In  segment CODE, align 2
   \                     ?Subroutine14:
   \   000000   5F480100     MOV.B   0x1(R8), R15
   \   000004                RPT     #0x8
   \   000004   47180F5F     RLAX.W  R15
   \   000008   1001         RETA
    513          
    514          /*********************************************************************
    515           * @fn          ZDO_ParseSimpleDescBuf
    516           *
    517           * @brief       Parse a byte sequence representation of a Simple Descriptor.
    518           *
    519           * @param       buf  - pointer to a byte array representing a Simple Desc.
    520           * @param       desc - SimpleDescriptionFormat_t *
    521           *
    522           *              This routine allocates storage for the cluster IDs because
    523           *              they are 16-bit and need to be aligned to be properly processed.
    524           *              This routine returns non-zero if an allocation fails.
    525           *
    526           *              NOTE: This means that the caller or user of the input structure
    527           *                    is responsible for freeing the memory
    528           *
    529           * @return      0: success
    530           *              1: failure due to malloc failure.
    531           */

   \                                 In  segment CODE, align 2
    532          uint8 ZDO_ParseSimpleDescBuf( uint8 *buf, SimpleDescriptionFormat_t *desc )
   \                     ZDO_ParseSimpleDescBuf:
    533          {
   \   000000   3B15         PUSHM.W #0x4, R11
   \   000002   084C         MOV.W   R12, R8
   \   000004   0B4D         MOV.W   R13, R11
    534            uint8 num, i;
    535          
    536            desc->EndPoint = *buf++;
   \   000006   FD480000     MOV.B   @R8+, 0(R13)
    537            desc->AppProfId = BUILD_UINT16( buf[0], buf[1] );
   \   00000A   ........     CALLA   #?Subroutine10
   \                     ??CrossCallReturnLabel_5:
   \   00000E   8D4E0200     MOV.W   R14, 0x2(R13)
    538            buf += 2;
   \   000012   2853         ADD.W   #0x2, R8
    539            desc->AppDeviceId = BUILD_UINT16( buf[0], buf[1] );
   \   000014   ........     CALLA   #?Subroutine10
   \                     ??CrossCallReturnLabel_6:
   \   000018   8D4E0400     MOV.W   R14, 0x4(R13)
    540            buf += 2;
   \   00001C   2853         ADD.W   #0x2, R8
    541            desc->AppDevVer = *buf >> 4;
   \   00001E   7E48         MOV.B   @R8+, R14
   \   000020                RPT     #0x4
   \   000020   43194E10     RRUX.B  R14
    542          
    543            desc->Reserved = 0;
   \   000024   CD4E0600     MOV.B   R14, 0x6(R13)
    544            buf++;
    545          
    546            // move in input cluster list (if any). allocate aligned memory.
    547            num = desc->AppNumInClusters = *buf++;
   \   000028   7A48         MOV.B   @R8+, R10
   \   00002A   CD4A0700     MOV.B   R10, 0x7(R13)
    548            if ( num )
   \   00002E   4A93         CMP.B   #0x0, R10
   \   000030   1824         JEQ     ??ZDO_ParseSimpleDescBuf_2
    549            {
    550              if (!(desc->pAppInClusterList = (uint16 *)osal_mem_alloc(num*sizeof(uint16))))
   \   000032   4C4A         MOV.B   R10, R12
   \   000034   0C5C         RLA.W   R12
   \   000036   ........     CALLA   #osal_mem_alloc
   \   00003A   8B4C0800     MOV.W   R12, 0x8(R11)
   \   00003E   0C93         CMP.W   #0x0, R12
   \   000040   2324         JEQ     ??ZDO_ParseSimpleDescBuf_3
    551              {
    552                // malloc failed. we're done.
    553                return 1;
    554              }
    555              for (i=0; i<num; ++i)
   \   000042   4E43         MOV.B   #0x0, R14
   \   000044   0C3C         JMP     ??ZDO_ParseSimpleDescBuf_4
    556              {
    557                desc->pAppInClusterList[i] = BUILD_UINT16( buf[0], buf[1] );
   \                     ??ZDO_ParseSimpleDescBuf_0:
   \   000046   6D48         MOV.B   @R8, R13
   \   000048   ........     CALLA   #?Subroutine14
   \                     ??CrossCallReturnLabel_11:
   \   00004C   0D5F         ADD.W   R15, R13
   \   00004E   494E         MOV.B   R14, R9
   \   000050   0959         RLA.W   R9
   \   000052   0F4C         MOV.W   R12, R15
   \   000054   0F59         ADD.W   R9, R15
   \   000056   8F4D0000     MOV.W   R13, 0(R15)
    558                buf += 2;
   \   00005A   2853         ADD.W   #0x2, R8
    559              }
   \   00005C   5E53         ADD.B   #0x1, R14
   \                     ??ZDO_ParseSimpleDescBuf_4:
   \   00005E   4E9A         CMP.B   R10, R14
   \   000060   F22B         JNC     ??ZDO_ParseSimpleDescBuf_0
    560            }
    561          
    562            // move in output cluster list (if any). allocate aligned memory.
    563            num = desc->AppNumOutClusters = *buf++;
   \                     ??ZDO_ParseSimpleDescBuf_2:
   \   000062   7A48         MOV.B   @R8+, R10
   \   000064   CB4A0A00     MOV.B   R10, 0xa(R11)
    564            if (num)
   \   000068   4A93         CMP.B   #0x0, R10
   \   00006A   2024         JEQ     ??ZDO_ParseSimpleDescBuf_5
    565            {
    566              if (!(desc->pAppOutClusterList = (uint16 *)osal_mem_alloc(num*sizeof(uint16))))
   \   00006C   4C4A         MOV.B   R10, R12
   \   00006E   0C5C         RLA.W   R12
   \   000070   ........     CALLA   #osal_mem_alloc
   \   000074   8B4C0C00     MOV.W   R12, 0xc(R11)
   \   000078   0C93         CMP.W   #0x0, R12
   \   00007A   0820         JNE     ??ZDO_ParseSimpleDescBuf_6
    567              {
    568                // malloc failed. free input cluster list memory if there is any
    569                if ( desc->pAppInClusterList != NULL )
   \   00007C   1C4B0800     MOV.W   0x8(R11), R12
   \   000080   0C93         CMP.W   #0x0, R12
   \   000082   0224         JEQ     ??ZDO_ParseSimpleDescBuf_3
    570                {
    571                  osal_mem_free(desc->pAppInClusterList);
   \   000084   ........     CALLA   #osal_mem_free
    572                }
    573                return 1;
   \                     ??ZDO_ParseSimpleDescBuf_3:
   \   000088   5C43         MOV.B   #0x1, R12
   \   00008A   113C         JMP     ??ZDO_ParseSimpleDescBuf_7
    574              }
    575              for (i=0; i<num; ++i)
   \                     ??ZDO_ParseSimpleDescBuf_6:
   \   00008C   4E43         MOV.B   #0x0, R14
   \   00008E   0C3C         JMP     ??ZDO_ParseSimpleDescBuf_8
    576              {
    577                desc->pAppOutClusterList[i] = BUILD_UINT16( buf[0], buf[1] );
   \                     ??ZDO_ParseSimpleDescBuf_1:
   \   000090   6B48         MOV.B   @R8, R11
   \   000092   ........     CALLA   #?Subroutine14
   \                     ??CrossCallReturnLabel_12:
   \   000096   0B5F         ADD.W   R15, R11
   \   000098   494E         MOV.B   R14, R9
   \   00009A   0959         RLA.W   R9
   \   00009C   0F4C         MOV.W   R12, R15
   \   00009E   0F59         ADD.W   R9, R15
   \   0000A0   8F4B0000     MOV.W   R11, 0(R15)
    578                buf += 2;
   \   0000A4   2853         ADD.W   #0x2, R8
    579              }
   \   0000A6   5E53         ADD.B   #0x1, R14
   \                     ??ZDO_ParseSimpleDescBuf_8:
   \   0000A8   4E9A         CMP.B   R10, R14
   \   0000AA   F22B         JNC     ??ZDO_ParseSimpleDescBuf_1
    580            }
    581            return 0;
   \                     ??ZDO_ParseSimpleDescBuf_5:
   \   0000AC   4C43         MOV.B   #0x0, R12
   \                     ??ZDO_ParseSimpleDescBuf_7:
   \   0000AE   3817         POPM.W  #0x4, R11
   \   0000B0   1001         RETA
    582          }
    583          
    584          
    585          /* ------------------------------------------------------------------------------------------------
    586           *                                     ZDProfile Proxy
    587           * ------------------------------------------------------------------------------------------------
    588           */
    589          
    590          /**************************************************************************************************
    591           * @fn          ZDP_MatchDescReq
    592           *
    593           * @brief       This builds and send a Match_Desc_req message.  This
    594           *              function sends a broadcast or unicast message
    595           *              requesting the list of endpoint/interfaces that
    596           *              match profile ID and cluster IDs.
    597           *
    598           * input parameters
    599           *
    600           * @param       dstAddr - destination address
    601           * @param       ProfileID - Profile ID
    602           * @param       NumInClusters - number of input clusters
    603           * @param       InClusterList - input cluster ID list
    604           * @param       NumOutClusters - number of output clusters
    605           * @param       OutClusterList - output cluster ID list
    606           * @param       SecurityEnable - Security Options
    607           *
    608           * output parameters
    609           *
    610           * None.
    611           *
    612           * @return      afStatus_t
    613           **************************************************************************************************
    614           */

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine5:
   \   000000   1D410400     MOV.W   0x4(SP), R13
   \   000004                REQUIRE ??Subroutine16_0
   \   000004                // Fall through to label ??Subroutine16_0

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine1:
   \   000000   2153         ADD.W   #0x2, SP
   \   000002   5617         POPM.W  #0x6, R11
   \   000004   1001         RETA

   \                                 In  segment CODE, align 2, keep-with-next
    615          afStatus_t ZDP_MatchDescReq(zAddrType_t *dstAddr, uint16 nwkAddr,
   \                     ZDP_MatchDescReq:
    616                                      uint16 ProfileID,
    617                                      byte NumInClusters, cId_t *InClusterList,
    618                                      byte NumOutClusters, cId_t *OutClusterList,
    619                                      byte SecurityEnable)
    620          {
   \   000000   5B15         PUSHM.W #0x6, R11
   \   000002   2183         SUB.W   #0x2, SP
   \   000004   0B4C         MOV.W   R12, R11
   \   000006   084D         MOV.W   R13, R8
   \   000008   094E         MOV.W   R14, R9
   \   00000A   4A4F         MOV.B   R15, R10
   \   00000C   56411400     MOV.B   0x14(SP), R6
    621            const uint8 len = 8 + ((NumInClusters + NumOutClusters) * 2);
   \   000010   4C4F         MOV.B   R15, R12
   \   000012   4C56         ADD.B   R6, R12
   \   000014   4C5C         RLA.B   R12
   \   000016   7C52         ADD.B   #0x8, R12
    622            uint8 *pBuf, *pPtr, cnt;
    623          
    624            (void)SecurityEnable;
    625          
    626            if ((Addr16Bit != dstAddr->addrMode) && (AddrBroadcast != dstAddr->addrMode))
   \   000018   5E4B0800     MOV.B   0x8(R11), R14
   \   00001C   6E93         CMP.B   #0x2, R14
   \   00001E   0524         JEQ     ??ZDP_MatchDescReq_2
   \   000020   7E900F00     CMP.B   #0xf, R14
   \   000024   0224         JEQ     ??ZDP_MatchDescReq_2
    627            {
    628              return afStatus_INVALID_PARAMETER;
   \   000026   6C43         MOV.B   #0x2, R12
   \   000028   333C         JMP     ??ZDP_MatchDescReq_3
    629            }
    630          
    631            pBuf = zap_msg_allocate(len, (uint8)MT_RPC_SYS_ZDO | (uint8)MT_RPC_CMD_SREQ,
    632                                         (uint8)MT_ZDO_MATCH_DESC_REQ);
   \                     ??ZDP_MatchDescReq_2:
   \   00002A   7E400600     MOV.B   #0x6, R14
   \   00002E   ........     CALLA   #?Subroutine2
    633          
    634            if (NULL == pBuf)
   \                     ??CrossCallReturnLabel_15:
   \   000032   0320         JNE     ??ZDP_MatchDescReq_4
    635            {
    636              return afStatus_MEM_FAIL;
   \   000034   7C401000     MOV.B   #0x10, R12
   \   000038   2B3C         JMP     ??ZDP_MatchDescReq_3
    637            }
    638          
    639            pPtr = pBuf;
   \                     ??ZDP_MatchDescReq_4:
   \   00003A   0F4C         MOV.W   R12, R15
    640            *pPtr++ = LO_UINT16(dstAddr->addr.shortAddr);
   \   00003C   EC4B0000     MOV.B   @R11, 0(R12)
   \   000040   1F53         ADD.W   #0x1, R15
    641            *pPtr++ = HI_UINT16(dstAddr->addr.shortAddr);
   \   000042   DF4B01000000 MOV.B   0x1(R11), 0(R15)
   \   000048   ........     CALLA   #?Subroutine7
    642            *pPtr++ = LO_UINT16(nwkAddr);
    643            *pPtr++ = HI_UINT16(nwkAddr);
    644            *pPtr++ = LO_UINT16(ProfileID);
    645            *pPtr++ = HI_UINT16(ProfileID);
   \                     ??CrossCallReturnLabel_4:
   \   00004C                RPT     #0x8
   \   00004C   47190910     RRUX.W  R9
   \   000050   CF490000     MOV.B   R9, 0(R15)
   \   000054   1F53         ADD.W   #0x1, R15
    646            *pPtr++ = NumInClusters;
   \   000056   CF4A0000     MOV.B   R10, 0(R15)
   \   00005A   1F53         ADD.W   #0x1, R15
    647            for (cnt = 0; cnt < NumInClusters; cnt++)
   \   00005C   4B43         MOV.B   #0x0, R11
   \   00005E   1D411200     MOV.W   0x12(SP), R13
   \   000062   023C         JMP     ??ZDP_MatchDescReq_5
    648            {
    649              *pPtr++ = LO_UINT16(*InClusterList);
   \                     ??ZDP_MatchDescReq_0:
   \   000064   ........     CALLA   #?Subroutine9
    650              *pPtr++ = HI_UINT16(*InClusterList);
    651              InClusterList++;
    652            }
   \                     ??ZDP_MatchDescReq_5:
   \   000068   4B9A         CMP.B   R10, R11
   \   00006A   FC2B         JNC     ??ZDP_MatchDescReq_0
    653            *pPtr++ = NumOutClusters;
   \   00006C   CF460000     MOV.B   R6, 0(R15)
   \   000070   1F53         ADD.W   #0x1, R15
    654            for (cnt = 0; cnt < NumOutClusters; cnt++)
   \   000072   4B43         MOV.B   #0x0, R11
   \   000074   1D411600     MOV.W   0x16(SP), R13
   \   000078   023C         JMP     ??ZDP_MatchDescReq_6
    655            {
    656              *pPtr++ = LO_UINT16(*OutClusterList);
   \                     ??ZDP_MatchDescReq_1:
   \   00007A   ........     CALLA   #?Subroutine9
    657              *pPtr++ = HI_UINT16(*OutClusterList);
    658              OutClusterList++;
    659            }
   \                     ??ZDP_MatchDescReq_6:
   \   00007E   4B96         CMP.B   R6, R11
   \   000080   FC2B         JNC     ??ZDP_MatchDescReq_1
    660          
    661            zapPhySend(zapAppPort, pBuf);
   \   000082   ........     CALLA   #?Subroutine5
    662            cnt = ZAP_SRSP_STATUS(pBuf);
   \                     ??CrossCallReturnLabel_20:
   \   000086   2F41         MOV.W   @SP, R15
   \   000088   6B4F         MOV.B   @R15, R11
    663            zap_msg_deallocate(&pBuf);
   \   00008A   ........     CALLA   #?Subroutine6
    664          
    665            return (afStatus_t)cnt;
   \                     ??CrossCallReturnLabel_1:
   \   00008E   4C4B         MOV.B   R11, R12
   \                     ??ZDP_MatchDescReq_3:
   \   000090   ....         JMP     ?Subroutine1
   \   000092   0343         NOP
    666          }

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine9:
   \   000000   EF4D0000     MOV.B   @R13, 0(R15)
   \   000004   1F53         ADD.W   #0x1, R15
   \   000006   3E4D         MOV.W   @R13+, R14
   \   000008                RPT     #0x8
   \   000008   47190E10     RRUX.W  R14
   \   00000C   CF4E0000     MOV.B   R14, 0(R15)
   \   000010   1F53         ADD.W   #0x1, R15
   \   000012   5B53         ADD.B   #0x1, R11
   \   000014   1001         RETA

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine7:
   \   000000   1F53         ADD.W   #0x1, R15
   \   000002   CF480000     MOV.B   R8, 0(R15)
   \   000006   1F53         ADD.W   #0x1, R15
   \   000008                RPT     #0x8
   \   000008   47190810     RRUX.W  R8
   \   00000C   CF480000     MOV.B   R8, 0(R15)
   \   000010   1F53         ADD.W   #0x1, R15
   \   000012   CF490000     MOV.B   R9, 0(R15)
   \   000016   1F53         ADD.W   #0x1, R15
   \   000018   1001         RETA

   \                                 In  segment CODE, align 2
   \                     ?Subroutine2:
   \   000000   7D402500     MOV.B   #0x25, R13
   \   000004   ....         JMP     ?Subroutine15
   \   000006   0343         NOP
    667          
    668          /*********************************************************************
    669           * @fn          ZDP_SimpleDescReq
    670           *
    671           * @brief       This builds and send a NWK_Simple_Desc_req
    672           *              message.  This function sends unicast message to the
    673           *              destination device.
    674           *
    675           * @param       dstAddr - destination address
    676           * @param       nwkAddr - 16 bit address
    677           * @param       epIntf - endpoint/interface
    678           * @param       SecurityEnable - Security Options
    679           *
    680           * @return      afStatus_t
    681           */

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine0:
   \   000000   2153         ADD.W   #0x2, SP
   \   000002   3817         POPM.W  #0x4, R11
   \   000004   1001         RETA

   \                                 In  segment CODE, align 2, keep-with-next
    682          afStatus_t ZDP_SimpleDescReq( zAddrType_t *dstAddr, uint16 nwkAddr,
   \                     ZDP_SimpleDescReq:
    683                                              byte endPoint, byte SecurityEnable )
    684          
    685          {
   \   000000   3B15         PUSHM.W #0x4, R11
   \   000002   2183         SUB.W   #0x2, SP
   \   000004   084C         MOV.W   R12, R8
   \   000006   0A4D         MOV.W   R13, R10
   \   000008   4B4E         MOV.B   R14, R11
    686            uint8 *pBuf, rtrn;
    687          
    688            (void)SecurityEnable;
    689          
    690            pBuf = zap_msg_allocate(5, (uint8)MT_RPC_SYS_ZDO | (uint8)MT_RPC_CMD_SREQ,
    691                                       (uint8)MT_ZDO_SIMPLE_DESC_REQ);
   \   00000A   6E42         MOV.B   #0x4, R14
   \   00000C   7D402500     MOV.B   #0x25, R13
   \   000010   7C400500     MOV.B   #0x5, R12
   \   000014   ........     CALLA   #?Subroutine15
    692            if (NULL == pBuf)
   \                     ??CrossCallReturnLabel_17:
   \   000018   0320         JNE     ??ZDP_SimpleDescReq_0
    693            {
    694              return afStatus_MEM_FAIL;
   \   00001A   7C401000     MOV.B   #0x10, R12
   \   00001E   133C         JMP     ??ZDP_SimpleDescReq_1
    695            }
    696          
    697            pBuf[0] = LO_UINT16(dstAddr->addr.shortAddr);
   \                     ??ZDP_SimpleDescReq_0:
   \   000020   EC480000     MOV.B   @R8, 0(R12)
    698            pBuf[1] = HI_UINT16(dstAddr->addr.shortAddr);
   \   000024   2F41         MOV.W   @SP, R15
   \   000026   DF4801000100 MOV.B   0x1(R8), 0x1(R15)
    699            pBuf[2] = LO_UINT16(nwkAddr);
   \   00002C   2F41         MOV.W   @SP, R15
   \   00002E   CF4A0200     MOV.B   R10, 0x2(R15)
    700            pBuf[3] = HI_UINT16(nwkAddr);
   \   000032                RPT     #0x8
   \   000032   47190A10     RRUX.W  R10
   \   000036   2F41         MOV.W   @SP, R15
   \   000038   CF4A0300     MOV.B   R10, 0x3(R15)
    701            pBuf[4] = endPoint;
   \   00003C   2F41         MOV.W   @SP, R15
   \   00003E   CF4B0400     MOV.B   R11, 0x4(R15)
    702          
    703            zapPhySend(zapAppPort, pBuf);
   \   000042   ........     CALLA   #?Subroutine3
    704            rtrn = ZAP_SRSP_STATUS(pBuf);
    705            zap_msg_deallocate(&pBuf);
    706          
    707            return (afStatus_t)rtrn;
   \                     ??ZDP_SimpleDescReq_1:
   \   000046   ....         JMP     ?Subroutine0
   \   000048   0343         NOP
    708          }

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine3:
   \   000000   1D410400     MOV.W   0x4(SP), R13
   \   000004   5C42....     MOV.B   &zapAppPort, R12
   \   000008   ........     CALLA   #zapPhySend
   \   00000C   1F410400     MOV.W   0x4(SP), R15
   \   000010   6A4F         MOV.B   @R15, R10
   \   000012   0C41         MOV.W   SP, R12
   \   000014   2C52         ADD.W   #0x4, R12
   \   000016   ........     CALLA   #zap_msg_deallocate
   \   00001A   4C4A         MOV.B   R10, R12
   \   00001C   1001         RETA
    709          
    710          /**************************************************************************************************
    711           * @fn          ZDP_EndDeviceBindReq
    712           *
    713           * @brief       This builds and sends a End_Device_Bind_req message.
    714           *              This function sends a unicast message.
    715           *
    716           * input parameters
    717           *
    718           * @param       dstAddr - destination address
    719           * @param       LocalCoordinator - short address of local coordinator
    720           * @param       epIntf - Endpoint/Interface of Simple Desc
    721           * @param       ProfileID - Profile ID
    722           *
    723           *   The Input cluster list is the opposite of what you would think.
    724           *   This is the output cluster list of this device
    725           * @param       NumInClusters - number of input clusters
    726           * @param       InClusterList - input cluster ID list
    727           *
    728           *   The Output cluster list is the opposite of what you would think.
    729           *   This is the input cluster list of this device
    730           * @param       NumOutClusters - number of output clusters
    731           * @param       OutClusterList - output cluster ID list
    732           *
    733           * @param       SecurityEnable - Security Options
    734           *
    735           * output parameters
    736           *
    737           * None.
    738           *
    739           * @return      afStatus_t
    740           **************************************************************************************************
    741           */

   \                                 In  segment CODE, align 2, keep-with-next
    742          afStatus_t ZDP_EndDeviceBindReq(zAddrType_t *dstAddr,
   \                     ZDP_EndDeviceBindReq:
    743                                          uint16 LocalCoordinator,
    744                                          byte endPoint,
    745                                          uint16 ProfileID,
    746                                          byte NumInClusters, cId_t *InClusterList,
    747                                          byte NumOutClusters, cId_t *OutClusterList,
    748                                          byte SecurityEnable)
    749          {
   \   000000   5B15         PUSHM.W #0x6, R11
   \   000002   2183         SUB.W   #0x2, SP
   \   000004   0A4C         MOV.W   R12, R10
   \   000006   0B4D         MOV.W   R13, R11
   \   000008   474E         MOV.B   R14, R7
   \   00000A   084F         MOV.W   R15, R8
   \   00000C   59411200     MOV.B   0x12(SP), R9
   \   000010   56411600     MOV.B   0x16(SP), R6
    750            const uint8 len = 17 + ((NumInClusters + NumOutClusters) * 2);
   \   000014   4C49         MOV.B   R9, R12
   \   000016   4C56         ADD.B   R6, R12
   \   000018   4C5C         RLA.B   R12
   \   00001A   7C501100     ADD.B   #0x11, R12
    751            uint8 *pBuf, *pPtr, cnt;
    752          
    753            (void)SecurityEnable;
    754          
    755            if ((Addr16Bit != dstAddr->addrMode) && (AddrBroadcast != dstAddr->addrMode))
   \   00001E   5E4A0800     MOV.B   0x8(R10), R14
   \   000022   6E93         CMP.B   #0x2, R14
   \   000024   0524         JEQ     ??ZDP_EndDeviceBindReq_2
   \   000026   7E900F00     CMP.B   #0xf, R14
   \   00002A   0224         JEQ     ??ZDP_EndDeviceBindReq_2
    756            {
    757              return afStatus_INVALID_PARAMETER;
   \   00002C   6C43         MOV.B   #0x2, R12
   \   00002E   323C         JMP     ??ZDP_EndDeviceBindReq_3
    758            }
    759          
    760            pBuf = zap_msg_allocate(len, (uint8)MT_RPC_SYS_ZDO | (uint8)MT_RPC_CMD_SREQ,
    761                                         (uint8)MT_ZDO_END_DEV_BIND_REQ);
   \                     ??ZDP_EndDeviceBindReq_2:
   \   000030   7E402000     MOV.B   #0x20, R14
   \   000034   ........     CALLA   #?Subroutine2
    762          
    763            if (NULL == pBuf)
   \                     ??CrossCallReturnLabel_14:
   \   000038   0320         JNE     ??ZDP_EndDeviceBindReq_4
    764            {
    765              return afStatus_MEM_FAIL;
   \   00003A   7C401000     MOV.B   #0x10, R12
   \   00003E   2A3C         JMP     ??ZDP_EndDeviceBindReq_3
    766            }
    767          
    768            pPtr = pBuf;
   \                     ??ZDP_EndDeviceBindReq_4:
   \   000040   0F4C         MOV.W   R12, R15
    769            *pPtr++ = LO_UINT16(dstAddr->addr.shortAddr);
   \   000042   EC4A0000     MOV.B   @R10, 0(R12)
   \   000046   1F53         ADD.W   #0x1, R15
    770            *pPtr++ = HI_UINT16(dstAddr->addr.shortAddr);
   \   000048   DF4A01000000 MOV.B   0x1(R10), 0(R15)
   \   00004E   1F53         ADD.W   #0x1, R15
    771            *pPtr++ = LO_UINT16(LocalCoordinator);
   \   000050   CF4B0000     MOV.B   R11, 0(R15)
   \   000054   1F53         ADD.W   #0x1, R15
    772            *pPtr++ = HI_UINT16(LocalCoordinator);
   \   000056                RPT     #0x8
   \   000056   47190B10     RRUX.W  R11
   \   00005A   CF4B0000     MOV.B   R11, 0(R15)
   \   00005E   1F53         ADD.W   #0x1, R15
    773            //(void)osal_memset(pPtr, 0, Z_EXTADDR_LEN);  // MT_ZDO ignores extended address.
    774            pPtr += Z_EXTADDR_LEN;
   \   000060   3F52         ADD.W   #0x8, R15
    775            *pPtr++ = endPoint;
   \   000062   CF470000     MOV.B   R7, 0(R15)
   \   000066   ........     CALLA   #?Subroutine7
    776            *pPtr++ = LO_UINT16(ProfileID);
    777            *pPtr++ = HI_UINT16(ProfileID);
    778            *pPtr++ = NumInClusters;
    779            for (cnt = 0; cnt < NumInClusters; cnt++)
   \                     ??CrossCallReturnLabel_3:
   \   00006A   4A43         MOV.B   #0x0, R10
   \   00006C   1B411400     MOV.W   0x14(SP), R11
   \   000070   023C         JMP     ??ZDP_EndDeviceBindReq_5
    780            {
    781              *pPtr++ = LO_UINT16(*InClusterList);
   \                     ??ZDP_EndDeviceBindReq_0:
   \   000072   ........     CALLA   #?Subroutine8
    782              *pPtr++ = HI_UINT16(*InClusterList);
    783              InClusterList++;
    784            }
   \                     ??ZDP_EndDeviceBindReq_5:
   \   000076   4A99         CMP.B   R9, R10
   \   000078   FC2B         JNC     ??ZDP_EndDeviceBindReq_0
    785            *pPtr++ = NumOutClusters;
   \   00007A   CF460000     MOV.B   R6, 0(R15)
   \   00007E   1F53         ADD.W   #0x1, R15
    786            for (cnt = 0; cnt < NumOutClusters; cnt++)
   \   000080   4A43         MOV.B   #0x0, R10
   \   000082   1B411800     MOV.W   0x18(SP), R11
   \   000086   023C         JMP     ??ZDP_EndDeviceBindReq_6
    787            {
    788              *pPtr++ = LO_UINT16(*OutClusterList);
   \                     ??ZDP_EndDeviceBindReq_1:
   \   000088   ........     CALLA   #?Subroutine8
    789              *pPtr++ = HI_UINT16(*OutClusterList);
    790              OutClusterList++;
    791            }
   \                     ??ZDP_EndDeviceBindReq_6:
   \   00008C   4A96         CMP.B   R6, R10
   \   00008E   FC2B         JNC     ??ZDP_EndDeviceBindReq_1
    792          
    793            zapPhySend(zapAppPort, pBuf);
   \   000090   ........     CALLA   #?Subroutine3
    794            cnt = ZAP_SRSP_STATUS(pBuf);
    795            zap_msg_deallocate(&pBuf);
    796          
    797            return (afStatus_t)cnt;
   \                     ??ZDP_EndDeviceBindReq_3:
   \   000094                REQUIRE ?Subroutine1
   \   000094                // Fall through to label ?Subroutine1
    798          }

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine8:
   \   000000   EF4B0000     MOV.B   @R11, 0(R15)
   \   000004   1F53         ADD.W   #0x1, R15
   \   000006   3E4B         MOV.W   @R11+, R14
   \   000008                RPT     #0x8
   \   000008   47190E10     RRUX.W  R14
   \   00000C   CF4E0000     MOV.B   R14, 0(R15)
   \   000010   1F53         ADD.W   #0x1, R15
   \   000012   5A53         ADD.B   #0x1, R10
   \   000014   1001         RETA
    799          
    800          /*********************************************************************
    801           * @fn          ZDO_RegisterForZDOMsg
    802           *
    803           * @brief       Call this function to register of an incoming over
    804           *              the air ZDO message - probably a response message
    805           *              but requests can also be received.
    806           *              Messages are delivered to the task with ZDO_CB_MSG
    807           *              as the message ID.
    808           *
    809           * @param       taskID - Where you would like the message delivered
    810           * @param       clusterID - What message?
    811           *
    812           * @return      ZSuccess - successful, ZMemError if not
    813           */

   \                                 In  segment CODE, align 2, keep-with-next
    814          ZStatus_t ZDO_RegisterForZDOMsg(uint8 taskID, uint16 clusterID)
   \                     ZDO_RegisterForZDOMsg:
    815          {
   \   000000   3B15         PUSHM.W #0x4, R11
   \   000002   4A4C         MOV.B   R12, R10
   \   000004   0B4D         MOV.W   R13, R11
    816            ZDO_MsgCB_t *pList;
    817            ZDO_MsgCB_t *pLast;
    818            ZDO_MsgCB_t *pNew;
    819            (void)taskID;
    820          
    821            // Look for duplicate
    822            pList = pLast = zdoMsgCBs;
   \   000006   1842....     MOV.W   &zdoMsgCBs, R8
   \   00000A   0F48         MOV.W   R8, R15
   \   00000C   023C         JMP     ??ZDO_RegisterForZDOMsg_1
    823            while ( pList )
    824            {
    825              if ( pList->taskID == taskID && pList->clusterID == clusterID )
    826                return ( ZSuccess );
    827              pLast = pList;
   \                     ??ZDO_RegisterForZDOMsg_0:
   \   00000E   084F         MOV.W   R15, R8
    828              pList = (ZDO_MsgCB_t *)pList->next;
   \   000010   2F4F         MOV.W   @R15, R15
   \                     ??ZDO_RegisterForZDOMsg_1:
   \   000012   0F93         CMP.W   #0x0, R15
   \   000014   0824         JEQ     ??ZDO_RegisterForZDOMsg_2
   \   000016   CF9C0200     CMP.B   R12, 0x2(R15)
   \   00001A   F923         JNE     ??ZDO_RegisterForZDOMsg_0
   \   00001C   8F9D0400     CMP.W   R13, 0x4(R15)
   \   000020   F623         JNE     ??ZDO_RegisterForZDOMsg_0
   \   000022   4C43         MOV.B   #0x0, R12
   \   000024   1A3C         JMP     ??ZDO_RegisterForZDOMsg_3
    829            }
    830          
    831            // Add to the list
    832            pNew = (ZDO_MsgCB_t *)osal_mem_alloc( sizeof ( ZDO_MsgCB_t ) );
   \                     ??ZDO_RegisterForZDOMsg_2:
   \   000026   3C400600     MOV.W   #0x6, R12
   \   00002A   ........     CALLA   #osal_mem_alloc
    833            if ( pNew )
   \   00002E   0C93         CMP.W   #0x0, R12
   \   000030   1224         JEQ     ??ZDO_RegisterForZDOMsg_4
    834            {
    835              pNew->taskID = taskID;
   \   000032   CC4A0200     MOV.B   R10, 0x2(R12)
    836              pNew->clusterID = clusterID;
   \   000036   8C4B0400     MOV.W   R11, 0x4(R12)
    837              pNew->next = NULL;
   \   00003A   8C430000     MOV.W   #0x0, 0(R12)
    838              if ( zdoMsgCBs )
   \   00003E   8293....     CMP.W   #0x0, &zdoMsgCBs
   \   000042   0324         JEQ     ??ZDO_RegisterForZDOMsg_5
    839              {
    840                pLast->next = pNew;
   \   000044   884C0000     MOV.W   R12, 0(R8)
   \   000048   023C         JMP     ??ZDO_RegisterForZDOMsg_6
    841              }
    842              else
    843                zdoMsgCBs = pNew;
   \                     ??ZDO_RegisterForZDOMsg_5:
   \   00004A   824C....     MOV.W   R12, &zdoMsgCBs
    844          
    845              return znp_ZDO_RegisterForZDOMsg(clusterID);
   \                     ??ZDO_RegisterForZDOMsg_6:
   \   00004E   0C4B         MOV.W   R11, R12
   \   000050   ........     CALLA   #znp_ZDO_RegisterForZDOMsg
   \   000054   023C         JMP     ??ZDO_RegisterForZDOMsg_3
    846            }
    847          
    848            return ZMemError;
   \                     ??ZDO_RegisterForZDOMsg_4:
   \   000056   7C401000     MOV.B   #0x10, R12
   \                     ??ZDO_RegisterForZDOMsg_3:
   \   00005A   3817         POPM.W  #0x4, R11
   \   00005C   1001         RETA
    849          }
    850          
    851          /*********************************************************************
    852           * @fn          ZDO_RemoveRegisteredCB
    853           *
    854           * @brief       Call this function if you don't want to receive the
    855           *              incoming message.
    856           *
    857           * @param       taskID - Where the messages are being delivered.
    858           * @param       clusterID - What message?
    859           *
    860           * @return      ZSuccess - successful, ZFailure if not found
    861           */

   \                                 In  segment CODE, align 2, keep-with-next
    862          ZStatus_t ZDO_RemoveRegisteredCB( uint8 taskID, uint16 clusterID )
   \                     ZDO_RemoveRegisteredCB:
    863          {
   \   000000   3B15         PUSHM.W #0x4, R11
   \   000002   2183         SUB.W   #0x2, SP
   \   000004   0A4D         MOV.W   R13, R10
    864            ZDO_MsgCB_t *pList;
    865            ZDO_MsgCB_t *pLast = NULL;
   \   000006   0B43         MOV.W   #0x0, R11
    866          
    867            pList = zdoMsgCBs;
   \   000008   1842....     MOV.W   &zdoMsgCBs, R8
   \   00000C   023C         JMP     ??ZDO_RemoveRegisteredCB_1
    868            while ( pList )
    869            {
    870              if ( pList->taskID == taskID && pList->clusterID == clusterID )
    871              {
    872                uint8 *pBuf, rtrn;
    873          
    874                // Note that this could be sent AREQ to free up the host (but then no status.)
    875                if (NULL == (pBuf = zap_msg_allocate(2, (uint8)MT_RPC_SYS_ZDO | (uint8)MT_RPC_CMD_SREQ,
    876                                                        (uint8)MT_ZDO_MSG_CB_REMOVE)))
    877                {
    878                  return ZMemError;
    879                }
    880          
    881                pBuf[0] = LO_UINT16(clusterID);
    882                pBuf[1] = HI_UINT16(clusterID);
    883          
    884                zapPhySend(zapAppPort, pBuf);
    885                rtrn = ZAP_SRSP_STATUS(pBuf);
    886                zap_msg_deallocate(&pBuf);
    887          
    888                if (ZSuccess != rtrn)
    889                {
    890                  return (ZStatus_t)rtrn;
    891                }
    892          
    893                if ( pLast )
    894                {
    895                  // remove this one from the linked list
    896                  pLast->next = pList->next;
    897                }
    898                else if ( pList->next )
    899                {
    900                  // remove the first one from the linked list
    901                  zdoMsgCBs = pList->next;
    902                }
    903                else
    904                {
    905                  // remove the only item from the list
    906                  zdoMsgCBs = (ZDO_MsgCB_t *)NULL;
    907                }
    908                osal_mem_free( pList );
    909                return ( ZSuccess );
    910              }
    911              pLast = pList;
   \                     ??ZDO_RemoveRegisteredCB_0:
   \   00000E   0B48         MOV.W   R8, R11
    912              pList = pList->next;
   \   000010   2848         MOV.W   @R8, R8
   \                     ??ZDO_RemoveRegisteredCB_1:
   \   000012   0893         CMP.W   #0x0, R8
   \   000014   3424         JEQ     ??ZDO_RemoveRegisteredCB_2
   \   000016   C89C0200     CMP.B   R12, 0x2(R8)
   \   00001A   F923         JNE     ??ZDO_RemoveRegisteredCB_0
   \   00001C   889D0400     CMP.W   R13, 0x4(R8)
   \   000020   F623         JNE     ??ZDO_RemoveRegisteredCB_0
   \   000022   7E403F00     MOV.B   #0x3f, R14
   \   000026   7D402500     MOV.B   #0x25, R13
   \   00002A   6C43         MOV.B   #0x2, R12
   \   00002C   ........     CALLA   #?Subroutine15
   \                     ??CrossCallReturnLabel_16:
   \   000030   0320         JNE     ??ZDO_RemoveRegisteredCB_3
   \   000032   7C401000     MOV.B   #0x10, R12
   \   000036   243C         JMP     ??ZDO_RemoveRegisteredCB_4
   \                     ??ZDO_RemoveRegisteredCB_3:
   \   000038   CC4A0000     MOV.B   R10, 0(R12)
   \   00003C                RPT     #0x8
   \   00003C   47190A10     RRUX.W  R10
   \   000040   2F41         MOV.W   @SP, R15
   \   000042   CF4A0100     MOV.B   R10, 0x1(R15)
   \   000046   ........     CALLA   #?Subroutine5
   \                     ??CrossCallReturnLabel_21:
   \   00004A   2F41         MOV.W   @SP, R15
   \   00004C   6A4F         MOV.B   @R15, R10
   \   00004E   ........     CALLA   #?Subroutine6
   \                     ??CrossCallReturnLabel_2:
   \   000052   4A93         CMP.B   #0x0, R10
   \   000054   0224         JEQ     ??ZDO_RemoveRegisteredCB_5
   \   000056   4C4A         MOV.B   R10, R12
   \   000058   133C         JMP     ??ZDO_RemoveRegisteredCB_4
   \                     ??ZDO_RemoveRegisteredCB_5:
   \   00005A   2F48         MOV.W   @R8, R15
   \   00005C   0B93         CMP.W   #0x0, R11
   \   00005E   0324         JEQ     ??ZDO_RemoveRegisteredCB_6
   \   000060   8B4F0000     MOV.W   R15, 0(R11)
   \   000064   073C         JMP     ??ZDO_RemoveRegisteredCB_7
   \                     ??ZDO_RemoveRegisteredCB_6:
   \   000066   0F93         CMP.W   #0x0, R15
   \   000068   0324         JEQ     ??ZDO_RemoveRegisteredCB_8
   \   00006A   824F....     MOV.W   R15, &zdoMsgCBs
   \   00006E   023C         JMP     ??ZDO_RemoveRegisteredCB_7
   \                     ??ZDO_RemoveRegisteredCB_8:
   \   000070   8243....     MOV.W   #0x0, &zdoMsgCBs
   \                     ??ZDO_RemoveRegisteredCB_7:
   \   000074   0C48         MOV.W   R8, R12
   \   000076   ........     CALLA   #osal_mem_free
   \   00007A   4C43         MOV.B   #0x0, R12
   \   00007C   013C         JMP     ??ZDO_RemoveRegisteredCB_4
    913            }
    914          
    915            return ( ZFailure );
   \                     ??ZDO_RemoveRegisteredCB_2:
   \   00007E   5C43         MOV.B   #0x1, R12
   \                     ??ZDO_RemoveRegisteredCB_4:
   \   000080                REQUIRE ?Subroutine0
   \   000080                // Fall through to label ?Subroutine0
    916          }
    917          
    918          /*********************************************************************
    919           * @fn          ZDO_SendMsgCBs
    920           *
    921           * @brief       De-mux the ZDO_CB_MSG from the ZNP.
    922           *
    923           * @param       inMsg - pointer to the incoming message buffer.
    924           *
    925           * @return      none
    926           */

   \                                 In  segment CODE, align 2
    927          static void ZDO_SendMsgCBs(zdoIncomingMsg_t *inMsg)
   \                     ZDO_SendMsgCBs:
    928          {
   \   000000   3B15         PUSHM.W #0x4, R11
   \   000002   0A4C         MOV.W   R12, R10
    929            ZDO_MsgCB_t *pList = zdoMsgCBs;
   \   000004   1B42....     MOV.W   &zdoMsgCBs, R11
   \   000008   293C         JMP     ??ZDO_SendMsgCBs_1
    930          
    931            while ( pList )
    932            {
    933              if ( pList->clusterID == inMsg->clusterID )
   \                     ??ZDO_SendMsgCBs_0:
   \   00000A   9B9A0E000400 CMP.W   0xe(R10), 0x4(R11)
   \   000010   2420         JNE     ??ZDO_SendMsgCBs_2
    934              {
    935                zdoIncomingMsg_t *msgPtr;
    936          
    937                // Send the address to the task
    938                msgPtr = (zdoIncomingMsg_t *)osal_msg_allocate( sizeof( zdoIncomingMsg_t ) + inMsg->asduLen );
   \   000012   5C4A1200     MOV.B   0x12(R10), R12
   \   000016   3C501800     ADD.W   #0x18, R12
   \   00001A   ........     CALLA   #osal_msg_allocate
   \   00001E   084C         MOV.W   R12, R8
    939                if ( msgPtr )
   \   000020   0C93         CMP.W   #0x0, R12
   \   000022   1B24         JEQ     ??ZDO_SendMsgCBs_2
    940                {
    941                  // copy struct
    942                  osal_memcpy( msgPtr, inMsg, sizeof( zdoIncomingMsg_t ));
   \   000024   3E401800     MOV.W   #0x18, R14
   \   000028   0D4A         MOV.W   R10, R13
   \   00002A   ........     CALLA   #osal_memcpy
    943          
    944                  if ( inMsg->asduLen )
   \   00002E   CA931200     CMP.B   #0x0, 0x12(R10)
   \   000032   0B24         JEQ     ??ZDO_SendMsgCBs_3
    945                  {
    946                    msgPtr->asdu = (byte*)(((byte*)msgPtr) + sizeof( zdoIncomingMsg_t ));
   \   000034   0C48         MOV.W   R8, R12
   \   000036   3C501800     ADD.W   #0x18, R12
   \   00003A   884C1600     MOV.W   R12, 0x16(R8)
    947                    osal_memcpy( msgPtr->asdu, inMsg->asdu, inMsg->asduLen );
   \   00003E   5E4A1200     MOV.B   0x12(R10), R14
   \   000042   1D4A1600     MOV.W   0x16(R10), R13
   \   000046   ........     CALLA   #osal_memcpy
    948                  }
    949          
    950                  msgPtr->hdr.event = ZDO_CB_MSG;
   \                     ??ZDO_SendMsgCBs_3:
   \   00004A   F840D3000000 MOV.B   #0xd3, 0(R8)
    951                  osal_msg_send( pList->taskID, (uint8 *)msgPtr );
   \   000050   0D48         MOV.W   R8, R13
   \   000052   5C4B0200     MOV.B   0x2(R11), R12
   \   000056   ........     CALLA   #osal_msg_send
    952                }
    953              }
    954              pList = (ZDO_MsgCB_t *)pList->next;
   \                     ??ZDO_SendMsgCBs_2:
   \   00005A   2B4B         MOV.W   @R11, R11
    955            }
   \                     ??ZDO_SendMsgCBs_1:
   \   00005C   0B93         CMP.W   #0x0, R11
   \   00005E   D523         JNE     ??ZDO_SendMsgCBs_0
    956          }
   \   000060   3817         POPM.W  #0x4, R11
   \   000062   1001         RETA
    957          
    958          #endif
    959          /**************************************************************************************************
    960          */

   Maximum stack usage in bytes:

   CSTACK Function
   ------ --------
       6  ZDOInitDevice
             6 -> osal_set_event
             6 -> osal_start_timerEx
             6 -> zapPhySend
             6 -> zap_msg_allocate
             6 -> zap_msg_deallocate
             6 -> zb_GetDeviceInfo
       8  ZDO_ParseDeviceAnnce
             8 -> sAddrExtCpy
      16  ZDO_ParseEPListRsp
            16 -> osal_mem_alloc
            16 -> osal_memcpy
      12  ZDO_ParseSimpleDescBuf
            12 -> osal_mem_alloc
            12 -> osal_mem_free
       4  ZDO_ParseSimpleDescRsp
             4 -> ZDO_ParseSimpleDescBuf
      12  ZDO_RegisterForZDOMsg
            12 -> osal_mem_alloc
            12 -> znp_ZDO_RegisterForZDOMsg
       4  ZDO_RegisterForZdoCB
      14  ZDO_RemoveRegisteredCB
            14 -> osal_mem_free
            14 -> zapPhySend
            14 -> zap_msg_allocate
            14 -> zap_msg_deallocate
      12  ZDO_SendMsgCBs
            12 -> osal_memcpy
            12 -> osal_msg_allocate
            12 -> osal_msg_send
       8  ZDO_UpdateNwkStatus
             8 -> osal_msg_allocate
             8 -> osal_msg_find
             8 -> osal_msg_send
             8 -> osal_set_event
      18  ZDP_EndDeviceBindReq
            18 -> zapPhySend
            18 -> zap_msg_allocate
            18 -> zap_msg_deallocate
      18  ZDP_MatchDescReq
            18 -> zapPhySend
            18 -> zap_msg_allocate
            18 -> zap_msg_deallocate
      14  ZDP_SimpleDescReq
            14 -> zapPhySend
            14 -> zap_msg_allocate
            14 -> zap_msg_deallocate
      10  zapZDO_ConcentratorIndicationCB
            10 -- Indirect call
      28  zapZdoProcessIncoming
            28 -> ZDO_SendMsgCBs
            28 -> osal_set_event
            28 -> osal_start_timerEx
            28 -> zapZDO_ConcentratorIndicationCB
       6  zapZdoSync
             6 -> osal_set_event
             6 -> osal_start_timerEx
             6 -> znp_ZDO_RegisterForZDOMsg


   Segment part sizes:

   Bytes  Function/Label
   -----  --------------
       8  ??Subroutine11_0
       8  ??Subroutine12_0
       8  ??Subroutine16_0
       6  ?Subroutine0
       6  ?Subroutine1
      10  ?Subroutine10
       6  ?Subroutine11
       4  ?Subroutine12
      12  ?Subroutine13
      10  ?Subroutine14
      12  ?Subroutine15
       8  ?Subroutine2
      30  ?Subroutine3
       4  ?Subroutine5
       8  ?Subroutine6
      26  ?Subroutine7
      22  ?Subroutine8
      22  ?Subroutine9
      92  ZDOInitDevice
      44  ZDO_ParseDeviceAnnce
      68  ZDO_ParseEPListRsp
     178  ZDO_ParseSimpleDescBuf
      40  ZDO_ParseSimpleDescRsp
      94  ZDO_RegisterForZDOMsg
      26  ZDO_RegisterForZdoCB
     128  ZDO_RemoveRegisteredCB
     100  ZDO_SendMsgCBs
      96  ZDO_UpdateNwkStatus
     148  ZDP_EndDeviceBindReq
     148  ZDP_MatchDescReq
      74  ZDP_SimpleDescReq
      56  zapZDO_ConcentratorIndicationCB
     132  zapZdoProcessIncoming
      52  zapZdoSync
      28  zdoCBFunc
       2  zdoMsgCBs

 
 1 686 bytes in segment CODE
    30 bytes in segment DATA16_Z
 
 1 686 bytes of CODE memory
    30 bytes of DATA memory

Errors: none
Warnings: none
